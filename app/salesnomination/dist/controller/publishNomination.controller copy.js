sap.ui.define(["sap/ui/Device","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/Popover","sap/m/Button","sap/m/library","sap/viz/ui5/controls/common/feeds/FeedItem","sap/viz/ui5/data/FlattenedDataset","sap/m/MessageBox","sap/m/MessageToast","external/ChartJSAdapterDateFns","external/ChartJS"],function(e,t,a,o,s,l,n,i,r,d,c,u){"use strict";let m=[];let g;let y=[];var D=[];let f;var h;let b;let p;let I;let P=Number.MAX_SAFE_INTEGER;let M=0;return t.extend("com.ingenx.nomination.salesnomination.controller.publishNomination",{onInit:function(){I=this.getView();var e=new a({pane1:"200px",pane2:"auto",pane3:"auto"});I.setModel(e,"sizes");const t={DeliveryPoints:[{DeliveryPt:"",DNQ:"",UOM:"",FromT:"",ToT:"",Event:""}]};const o={RedeliveryPoints:[{RedeliveryPt:"",DNQ:"",UOM:"",FromT:"",ToT:"",Event:""}]};const s=new sap.ui.model.json.JSONModel(t);const l=new sap.ui.model.json.JSONModel(o);this.getView().setModel(s,"DelvModelData");this.getView().setModel(l,"RedlvModelData")},onRootContainerResize:function(e){var t=e.getParameter("oldSizes"),a=e.getParameter("newSizes"),o="Root container is resized.";if(t&&t.length){o+="\nOld panes sizes = ["+t+"]"}o+="\nNew panes sizes = ["+a+"]"},onInnerContainerResize:function(e){var t=e.getParameter("oldSizes"),a=e.getParameter("newSizes"),o="Inner container is resized.";if(t&&t.length){o+="\nOld panes sizes = ["+t+"]"}o+="\nNew panes sizes = ["+a+"]"},onTimeChange:function(e){var t=e.getParameter("value");var a=this.getView().getModel("RedlvModelData");a.setProperty(e.getSource().getBinding("value").getPath(),t)},onAddPress:function(){const e=this.getView().getModel("RedlvModelData");const t=e.getProperty("/RedeliveryPoints");console.log("aRedeliveryPoints ",t);t.push({RedeliveryPt:t[0].RedeliveryPt,DNQ:"",UOM:t[0].UOM,FromT:"",ToT:"",Event:""});e.setProperty("/RedeliveryPoints",t);this.updateDNQSum()},onAddRowDlvPress:function(){const e=this.getView().getModel("DelvModelData");const t=e.getProperty("/DeliveryPoints");console.log("aRedeliveryPoints ",t);t.push({DeliveryPt:t[0].DeliveryPt,DNQ:"",UOM:t[0].UOM,FromT:"",ToT:"",Event:""});e.setProperty("/DeliveryPoints",t);this.updateDNQSum()},onDeletePress:function(){var e=this.byId("IdPubNomRedPointTable");var t=this.getView().getModel("RedlvModelData");var a=t.getProperty("/RedeliveryPoints");var o=e.getSelectedItems();if(o.length>0){var s=o[0];var l=e.indexOfItem(s);if(l>0){a.splice(l,1)}}else if(a.length>1){a.pop()}t.setProperty("/RedeliveryPoints",a);this.updateDNQSum()},onDeleteRowDlvPress:function(){var e=this.byId("IdPubNomDelPointTable");var t=this.getView().getModel("DelvModelData");var a=t.getProperty("/DeliveryPoints");var o=e.getSelectedItems();if(o.length>0){var s=o[0];var l=e.indexOfItem(s);if(l>0){a.splice(l,1)}}else if(a.length>1){a.pop()}t.setProperty("/DeliveryPoints",a);this.updateDNQSum()},updateDNQSum:function(){const e=this.getView().getModel("RedlvModelData");const t=e.getProperty("/RedeliveryPoints");let a=t.reduce(function(e,t){return e+parseFloat(t.DNQ||0)},0);e.setProperty("/DNQSum",a);console.log("sumDNQ",a)},onLoadContractModel:async function(){let e=new sap.ui.model.json.JSONModel;I.setModel(e,"salesContractData")},onSoldToParty:function(){if(!this._oInfoDialogSTP){this._oInfoDialogSTP=sap.ui.xmlfragment(I.getId(),"com.ingenx.nomination.salesnomination.fragment.soldToParty",this);I.addDependent(this._oInfoDialogSTP)}this._oInfoDialogSTP.open()},onValueHelpSearchSTP1:function(e){var t=e.getParameter("value");var a=new sap.ui.model.Filter("Customer",sap.ui.model.FilterOperator.Contains,t);e.getSource().getBinding("items").filter([a])},onValueHelpSearchSTP:function(e){var t=e.getParameter("value").toUpperCase();var a=new sap.ui.model.Filter("Customer",sap.ui.model.FilterOperator.Contains,t);var o=e.getSource().getBinding("items");var s=e.getSource();o.filter([a]);o.attachEventOnce("dataReceived",function(){var e=o.getCurrentContexts();if(e.length===0){s.setNoDataText("No data found")}else{s.setNoDataText("Loading")}})},onValueHelpConfirmSTP:async function(e){try{let t=e.getParameter("selectedItem");if(!t){console.warn("No item selected in value help dialog.");return}let a=t.getBindingContext().getObject();this.byId("IdPubNomSoldToPartyInput").setValue(a.Customer);console.log("Selected Customer:",a.Customer);let o=this.getView();o.byId("IdPubNomContractsPage").setBusy(true);let s=`/getNominationsByCustomer?DocType=S&Customer=${encodeURIComponent(a.Customer)}`;let l=this.getOwnerComponent().getModel();let n;try{let e=l.bindList(s,null,null,null);n=await e.requestContexts(0,Infinity)}catch(e){console.error("Error fetching nominations:",e.message||e);o.byId("IdPubNomContractsPage").setBusy(false);return}let i=n.map(e=>e.getObject());console.log("Fetched Contracts:",i);if(i.length===0){console.warn("No nominations found for the selected customer.");o.byId("IdPubNomContractsPage").setBusy(false);return}let r=new sap.ui.model.json.JSONModel;o.setModel(r,"newModelForContracts");r.setProperty("/data",i);o.getModel("newModelForContracts").refresh();o.byId("IdPubNomContractsPage").setBusy(false)}catch(e){this.getView().byId("IdPubNomContractsPage").setBusy(false);console.error("Unexpected error in onValueHelpConfirmSTP:",e.message||e)}},onValueHelpConfirmSTP1:async function(e){var t=e.getParameter("selectedItem");if(!t){return}let a=t.getBindingContext().getObject();this.byId("IdPubNomSoldToPartyInput").setValue(a.Customer);console.log("Selected Customer:",a.Customer);I.byId("IdPubNomContractsPage").setBusy(true);await this.filterContractsByCustomer(a.Customer).then(e=>{let t=I.getModel("newModelForContracts");if(!t){t=new sap.ui.model.json.JSONModel;I.setModel(t,"newModelForContracts")}t.setProperty("/data",e[0]);console.log("Filtered Contracts:",e[0]);I.getModel("newModelForContracts").refresh()}).catch(e=>{sap.m.MessageBox.error(`Error fetching contracts: ${e.message||"Unknown error occurred"}`);console.error("Error fetching contracts:",e)});this._oInfoDialogSTP.getBinding("items").filter([])},onContDescLiveChange:function(e){var t=e.getParameter("value");var a=this.byId("idlst");var o=new sap.ui.model.Filter("ContractDescription",sap.ui.model.FilterOperator.Contains,t);var s=a.getBinding("items");s.filter([o]);if(s.getLength()===0){a.setNoDataText("No Contracts Found")}else{a.setNoDataText("Loading...")}},onBackMat:function(){try{const e=this.byId("IdPubNomVboxMaterials");const t=this.byId("IdPubNomVboxContracts");const a=e.getVisible();e.setVisible(!a);t.setVisible(a);const o=this.byId("IdPubNomDelPointTable");if(o){o.setVisible(false);this.byId("IdPubNomTableHeaderBarForDelv").setVisible(false)}this.clearMaterialModels()}catch(e){console.error("Error in onBackMat:",e);sap.m.MessageToast.show("An error occurred while processing. Please try again.")}},clearMaterialModels:function(){const e=this.getView().getModel("materialModel");const t=this.getView().getModel("modelData");const a=this.getView().getModel("RedlvModelData");const o=this.getView().getModel("DelvModelData");if(t){t.setData({})}if(a){a.setProperty("/RedeliveryPoints",[{RedeliveryPt:"",DNQ:"",UOM:"",FromT:"",ToT:"",Event:""}])}if(o){o.setProperty("/DeliveryPoints",[{DeliveryPt:"",DNQ:"",UOM:"",FromT:"",ToT:"",Event:""}])}if(e){e.setData({})}this.refreshModels([e,t,a,o])},refreshModels:function(e){e.forEach(e=>{if(e){e.refresh(true)}})},onSelectContract:async function(e){const t=this.getView();const a=t.byId("IdPubNomContractsPage");const o=t.byId("IdPubNomVboxContracts");const s=t.byId("IdPubNomVboxMaterials");const l=this.getOwnerComponent().getModel();a.setBusy(true);o.setVisible(false);s.setVisible(true);try{const a=e.getSource().getBindingContext("newModelForContracts").getObject();const o=`/getContractDetailsAndPastNom?Vbeln=${encodeURIComponent(a.Vbeln)}`;const s=l.bindList(o);const n=await s.requestContexts(0,Infinity);const i=n.map(e=>e.getObject());if(!i||i.length===0){sap.m.MessageToast.show("No nominations found for the selected contract.");return}let r=t.getModel("materialModel");if(!r){r=new sap.ui.model.json.JSONModel;t.setModel(r,"materialModel")}r.setProperty("/selectedMaterials",i)}catch(e){console.error("Error fetching contract details:",e.message||e);sap.m.MessageBox.error("Failed to fetch contract details. Please try again later.")}finally{a.setBusy(false)}},onSelectMaterial:async function(e){const t=this.getView();const a=t.byId("IdPubNomMainScrollContainer");const o=t.byId("IdPubNomDelPointTable");const s=t.byId("IdPubNomTableHeaderBarForDelv");try{const l=this.getView().getModel("RedlvModelData");const n=this.getView().getModel("DelvModelData");l.setProperty("/RedeliveryPoints",[{RedeliveryPt:"",DNQ:"",UOM:"",FromT:"",ToT:"",Event:""}]);n.setProperty("/RedeliveryPoints",[{DeliveryPt:"",DNQ:"",UOM:"",FromT:"",ToT:"",Event:""}]);l.refresh();n.refresh();a.setBusy(true);const i=e.getSource().getBindingContext("materialModel");if(!i){console.error("No binding context found for materialModel.");sap.m.MessageBox.warning("No data found for the selected material.");return}const r=i.getObject();console.log("Delv and Redelv Data",r);console.log("Delv and Redelv dynamicFields",r.dynamicFields);this.calculateDCQStatsByLabels(r.dynamicFields);console.log("maxDCQVal",M+"....."+P);let d=t.getModel("modelData");if(!d){d=new sap.ui.model.json.JSONModel;t.setModel(d,"modelData")}d.setData(r);const c=this.getView().getModel("RedlvModelData");const u=this.getView().getModel("DelvModelData");c.setProperty("/RedeliveryPoints/0/RedeliveryPt",r.RedeliveryPt);c.setProperty("/RedeliveryPoints/0/UOM",r.UOM);if(r.DeliveryPt){u.setProperty("/DeliveryPoints/0/DeliveryPt",r.DeliveryPt);u.setProperty("/DeliveryPoints/0/UOM",r.UOM);o.setVisible(true);s.setVisible(true)}else{o.setVisible(false);s.setVisible(false)}sap.m.MessageToast.show("Material selected successfully.")}catch(e){console.error("Error during material selection:",e.message||e);sap.m.MessageBox.error("An error occurred while processing the material selection. Please try again.")}finally{a.setBusy(false)}},calculateDCQStatsByLabels:function(e,t){if(e.length===0){return}for(let t=0;t<e.length;t++){const a=e[t].value;M=Math.max(M,a);P=Math.min(P,a)}},_generateDynamicChart:function(e,t,a,o,s,l,n){let i=I.byId("chartContainer");i.destroyItems();let r=document.createElement("canvas");i.getDomRef().appendChild(r);let d=r.getContext("2d");let c=[];let u=24*60*60*1e3;for(let a=new Date(e);a<=t;a=new Date(a.getTime()+u)){c.push(new Date(a).toISOString().split("T")[0])}let m=Array(c.length).fill(Number(a));let g=Array(c.length).fill(Number(o));let y=Array(c.length).fill(Number(s));let D=c.map(e=>{let t=l.find(t=>new Date(t.Gasday).toISOString().split("T")[0]===e);return t?t.Adnq:null});let f=c.map(e=>{let t=n.find(t=>new Date(t.Gasday).toISOString().split("T")[0]===e);return t?t.alloNom:null});let h={labels:c,datasets:[{label:"DCQ",data:m,borderColor:"#28a745",borderWidth:2,borderDash:[5,5],fill:false,pointRadius:0,yAxisID:"y1",pointStyle:"line"},{label:"Min DCQ",data:g,borderColor:"#87CEEB",borderWidth:2,borderDash:[5,5],fill:false,pointRadius:0,yAxisID:"y1",pointStyle:"line"},{label:"Max DCQ",data:y,borderColor:"black",borderWidth:2,borderDash:[5,5],fill:false,pointRadius:0,yAxisID:"y1",pointStyle:"line"},{label:"Adnq",data:D,borderColor:"blue",borderWidth:2,fill:false,yAxisID:"y1",spanGaps:true,pointStyle:"line"},{label:"alloQty",data:f,borderColor:"purple",borderWidth:2,borderDash:[2,2],fill:false,yAxisID:"y1",spanGaps:true,pointStyle:"line"}]};if(this.myChart){this.myChart.data=h;this.myChart.update()}else{this.myChart=new Chart(d,{type:"line",data:h,options:{responsive:true,interaction:{mode:"nearest",intersect:false},maintainAspectRatio:false,scales:{x:{type:"time",time:{unit:"month",displayFormats:{month:"yyyy-MMM"}},title:{text:"Validity",display:true}},y1:{beginAtZero:false,title:{display:true,text:"DCQ Values"},position:"left",suggestedMin:Math.min(...m,o)*.9,suggestedMax:Math.max(...m,s)*1.1,grid:{drawOnChartArea:false}}},plugins:{legend:{display:true,position:"bottom",labels:{usePointStyle:true}},tooltip:{enabled:true,callbacks:{label:function(e){let t=e.dataset.label||"";if(t){t+=": "}if(e.dataset.label==="DNQ"){t+=e.raw.y}else if(e.raw!==null){t+=e.raw.toLocaleString()}return t}}}},responsive:true,maintainAspectRatio:false,layout:{padding:{top:20,left:20,right:20,bottom:20}}}})}},_addDNQPointToChart:function(e,t,a){const{dnq:o,gasDay:s}=a;const l=new Date(s);if(!this.myChart.data.datasets.some(e=>e.label==="DNQ")){this.myChart.data.datasets.push({label:"DNQ",data:[],borderColor:"red",pointBackgroundColor:"red",pointRadius:5,fill:false,showLine:false,yAxisID:"y1"})}const n=this.myChart.data.datasets.find(e=>e.label==="DNQ");n.data.push({x:l,y:o});this.myChart.update()},selectContractNo:async function(e,t,a,o){let s=I.getModel("salesContractData");s.setData({});console.log("contract data is:",this.contractDataModel);if(!this.contractDataModel||this.contractDataModel.length===0){console.error("Contract data model is empty or undefined.");return}let l=this.contractDataModel.flatMap(s=>s.to_contract.filter(s=>s.Vbeln===e&&s.to_material.some(e=>e.Material===t&&e.to_rdp.some(e=>e.RedeliveryPt===a&&e.DeliveryPt===o))));if(l.length>0){let e=l[0];let o=this.contractDataModel.find(t=>t.Customer===e.Customer);let n=e.to_material.find(e=>e.Material===t&&e.to_rdp.some(e=>e.RedeliveryPt===a));let i=n&&n.to_rdp.find(e=>e.RedeliveryPt===a);let r=i&i.ItemNo||"";let d={};n.to_item.forEach(e=>{if(e.ItemNo===r){d[e.ClauseCode.trim()]=e.CalculatedValue}});let c={...e,Material:n?n.Material:"",ServProfile:n?n.ServProfile:"",DCQ:n?n.DCQ:"",MaxDCQ:d["Max DCQ"||"Max Dcq"||"MDCQ"]||"",MinDCQ:d["Min DCQ"||"Min Dcq"||"mDCQ"]||"",UOM:n?n.UOM:"",DeliveryPt:i?i.DeliveryPt:"",RedeliveryPt:i?i.RedeliveryPt:"",ItemNo:n.ItemNo,Supplier:o?o.Supplier:"",SupplierName:o?o.SupplierName:""};Object.entries(d).forEach(([e,t])=>{c[e]=t});s.setData(c);console.log("Sales Contract Data:",c);let u=this.getOwnerComponent().getModel();let m=u.bindList("/serviceProfileParametersItems");await m.requestContexts(0,Infinity).then(e=>{let t=e.map(e=>{let t=e.getObject();t.serviceParameter=t.serviceParameter.replace(/\s+/g,"");return t});let a=c.ServProfile;let o=t.filter(e=>e.serviceProfileName===a&&e.Nomination_Relevant===true);let s=I.byId("parameterList");let l=new sap.ui.model.json.JSONModel({parameters:o});s.setModel(l,"serviceProfData");console.log("salesContractData:",c);console.log("serviceProfData:",l.getData());this.updateUIFields(c)})}else{console.warn("No matching contract found for the provided criteria.")}},updateUIFields:function(e){I.byId("selectedDate").setValue("");I.byId("dnqGSA").setValue("");I.byId("contractID").setValue(e.Vbeln);I.byId("materialID").setValue(e.Material);I.byId("docTypeID").setValue(e.ContractDescription);let t=I.byId("IdPubNomDelPointTable");if(e.DeliveryPt){if(t){t.setVisible(true);I.byId("IdPubNomDelvPointInput").setValue(e.DeliveryPt);I.byId("UomDp").setValue(e.UOM)}else{console.error("Delivery Point table 'delPointTable' not found")}}else{if(t){t.setVisible(false)}else{console.error("Delivery Point table 'delPointTable' not found")}}let a=I.byId("redPointTable");if(a){a.setVisible(true);I.byId("reDelPointID").setValue(e.RedeliveryPt);I.byId("uomInput").setValue(e.UOM)}else{console.error("Re-Delivery Point table '_IDGenTable2' not found")}let o=I.byId("parameterList");if(o){let t=o.getItems();t.forEach(function(t){let a=t.getLabel().slice(0,-1);let o=e[a];if(o!==undefined){t.setValue(o.toString());t.setVisible(true)}else{console.log(`Field '${a}' not found in salesContractData.`);t.setValue("");t.setVisible(false)}})}else{console.error("List 'parameterList' not found in the view.")}},initModelsForCreate:async function(){this.NominationDataModel=[];this.purchArray=[];let e=I.getModel("nominationDataModel");let t=this.getOwnerComponent().getModel();let a=t.bindList("/xGMSxGMS_nom");await a.requestContexts(0,Infinity).then(t=>{this.NominationDataModel=t.map(e=>e.getObject());e.setData(this.NominationDataModel);console.log("Nomination Data:",this.NominationDataModel)}).catch(e=>{console.error("Error fetching Nomination data:",e)});let o=t.bindList("/transportAgreementDetail");await o.requestContexts(0,Infinity).then(e=>{this.purchArray=e.map(e=>e.getObject());console.log("Purchase Data:",this.purchArray)}).catch(e=>{console.error("Error fetching Purchase Agreement data:",e)});let s="/ZNOMMASTER8";let l={$expand:"to_contract($filter=DocType eq 'S';$expand=to_material($expand=to_rdp,to_item))"};let n=t.bindList(s,undefined,undefined,undefined,l);await n.requestContexts(0,Infinity).then(e=>{this.contractDataModel=e.map(e=>e.getObject());console.log("Contract Data Model:",this.contractDataModel)}).catch(e=>{console.error("Error fetching Contract data:",e)})},onliveInputDNQ:function(e){const t=e.getParameter("value");const a=e.getSource();const o=1e3;const s=2e3;const l=parseFloat(t);let n="None";let i="";if(t===""){n="None";i=""}else if(isNaN(l)){n="Error";i="Please enter a valid float number."}else if(l<o){n="Error";i=`DNQ should be >= ${o}.`}else if(l>s){n="Error";i=`DNQ should be <= ${s}.`}else{n="None";i=""}a.setValueState(n);a.setValueStateText(i)},DcqValidation:function(e){let t=I.getModel("salesContractData");let a=t.getProperty("/MaxDCQ"||"/maxDCQ"||"/MDCQ");let o=t.getProperty("/MinDCQ"||"/minDCQ"||"/mDCQ");let s=I.byId("dnqGSA");if(!s){console.error("Element with ID 'dnqGSA' not found.");return}let l=s.getValue();let n=parseFloat(l);let i=I.byId("eventInput").getSelectedItem();if(i){I.byId("messageGSA").setVisible(true);I.byId("messageGSA").setText("")}else{if(isNaN(n)){I.byId("messageGSA").setVisible(true);I.byId("messageGSA").setText("")}else if(n>=o&&n<=a&&n>=0){I.byId("messageGSA").setVisible(true);I.byId("messageGSA").setText("");var r=this.byId("eventInput");r.setEnabled(false)}else{var r=this.byId("eventInput");r.setEnabled(true);this.handleDnqValidationErrors(n,o,a,"messageGSA")}}if(I.byId("IdPubNomDelPointTable").getVisible()){let e=I.byId("dnqGTA").getValue();let t=parseFloat(e);let s=I.byId("eventInputGTA").getSelectedItem();if(s){s=s&s.getText();console.log(s);if(s=="No-event"){this.handleDnqValidationError(t,o,a,"messageGTA")}else{I.byId("messageGTA").setVisible(true);I.byId("messageGTA").setText("")}}else{if(isNaN(t)){I.byId("messageGTA").setVisible(true);I.byId("messageGTA").setText("")}else if(t>=o&&t<=a&&t>=0){I.byId("messageGTA").setVisible(true);I.byId("messageGTA").setText("");var r=this.byId("eventInputGTA");r.setEnabled(false)}else{var r=this.byId("eventInputGTA");r.setEnabled(true);this.handleDnqValidationError(t,o,a,"messageGTA")}}}},handleDnqValidationErrors:function(e,t,a,o){if(e>=t&&e<=a&&e>=0){I.byId("messageGSA").setVisible(true);I.byId("messageGSA").setText("")}if(e<t){I.byId("messageGSA").setVisible(true);I.byId("messageGSA").setText("*DNQ should be more than min DCQ ")}else if(e>a){I.byId("messageGSA").setVisible(true);I.byId("messageGSA").setText("*DNQ should be less than max DCQ ")}else if(e<=0){I.byId("messageGSA").setVisible(true);I.byId("messageGSA").setText("*DNQ should not be less than 1.")}},handleDnqValidationError:function(e,t,a,o){if(e>=t&&e<=a&&e>=0){I.byId("messageGTA").setVisible(true);I.byId("messageGTA").setText("")}if(e<t){I.byId("messageGTA").setVisible(true);I.byId("messageGTA").setText("*DNQ should be more than min DCQ ")}else if(e>a){I.byId("messageGTA").setVisible(true);I.byId("messageGTA").setText("*DNQ should be less than max DCQ ")}else if(e<=0){I.byId("messageGTA").setVisible(true);I.byId("messageGTA").setText("*DNQ should not be less than 1.")}},onSelectOption:function(){p=I.byId("selectedDate").getValue();var e=new Date(p);var t=new Date;if(e<t){sap.m.MessageBox.error("Please select a future date.");I.byId("selectedDate").setValue("")}else{var a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});h=a.format(e)}this.formattedTimestamp=t.toISOString()},EventsGSA:function(e){let t=I.getModel("salesContractData");let a=t.getProperty("/MaxDCQ"||"/maxDCQ"||"/MDCQ");let o=t.getProperty("/MinDCQ"||"/minDCQ"||"/mDCQ");let s=I.byId("dnqGSA");let l=s.getValue();let n=parseFloat(l);let i=e.getSource().getSelectedItem();if(i){i=i&i.getText();if(i=="No-event"){console.log("reached.");this.handleDnqValidationErrors(n,o,a,"messageGSA")}else{I.byId("messageGSA").setVisible(true);I.byId("messageGSA").setText("")}}},EventGTA:function(e){let t=I.getModel("salesContractData");let a=t.getProperty("/MaxDCQ"||"/maxDCQ"||"/MDCQ");let o=t.getProperty("/MinDCQ"||"/minDCQ"||"/mDCQ");let s=I.byId("dnqGTA").getValue();let l=parseFloat(s);b=e.getSource().getSelectedItem();if(b){b=b&b.getText();if(b=="No-event"){console.log("GtaSelectedEventtttt is blank hua");this.handleDnqValidationError(l,o,a,"messageGTA")}else{I.byId("messageGTA").setVisible(true);I.byId("messageGTA").setText("")}}},onSelectedDate:function(){var e=this.getView().byId("IdPubNomGasDayPicker");var t=e.getDateValue();console.log("sDate",t)},onChangeAddDecimal:function(e){var t=e.getSource();var a=t.getValue().trim();var o=parseFloat(a);if(!a){t.setValue("0.000");return}if(!isNaN(o)){var s=o.toFixed(3);t.setValue(s);var l=t.getBinding("value")?t.getBinding("value").getPath():null;var n=t.getModel();if(n&&l){n.setProperty(l,s)}}else{t.setValue("0.000")}},createNomination:async function(){let e=this.getView().byId("IdPubNomGasDayPicker").getDateValue();const t=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});e=t.format(e);if(!e){sap.m.MessageBox.error("Please select a Gas Day!");return}const a=this.getView().getModel("RedlvModelData").getData();const o=this.getView().getModel("modelData").getData();console.log("oModelDataRedlv ",a);console.log("selectedMaterialData ",o);let s=[];for(let t=0;t<a.RedeliveryPoints.length;t++){let l={Gasday:e,Vbeln:o.Vbeln,ItemNo:o.ItemNo,NomItem:(10+t).toString(),Versn:"",DeliveryPoint:"",RedelivryPoint:a.RedeliveryPoints[t].RedeliveryPt,ValidTo:a.RedeliveryPoints[t].ToT,ValidFrom:a.RedeliveryPoints[t].FromT,Material:o.Material,Kunnr:"",Auart:o.Auart,Ddcq:"0.000",Rdcq:"0.000",Uom1:a.RedeliveryPoints[t].UOM,Pdnq:a.RedeliveryPoints[t].DNQ,Event:a.RedeliveryPoints[t].Event,Adnq:"0.000",Rpdnq:"0.000",Znomtk:"",Src:"",Remarks:"",Flag:"",Action:"",Path:"",CustGrp:"",SrvProfile:""};s.push(l)}let l={Gasday:e,Vbeln:o.Vbeln,nomi_toitem:s};return;console.log("createNomPayLoad",l);let n=this.getOwnerComponent().getModel();let i=n.bindList("/znom_headSet");var d=new sap.m.BusyDialog;d.open();try{let e=await i.create(l,true);console.log("result ",e);r.success("Nomination Successfully Submitted")}catch(e){console.error("Error during create operation:",e);r.error("An error occurred while submitting the nomination. Please try again.")}finally{d.close()}return},checkExistingNomination:function(e){let t=I.getModel("nominationDataModel").getData();let a=I.getModel("salesContractData");let o=I.byId("contractID").getValue();let s=a.getProperty("/Material");let l=h;let n=t.find(e=>e.Vbeln===o&&e.Material===s&&e.Gasday===l);if(n){sap.m.MessageBox.confirm(`A nomination already exists for this material on ${l} with DNQ ${n.PDnq}. Do you want to continue?`,{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e===sap.m.MessageBox.Action.OK){this.checkNomValue()}}.bind(this)})}else{this.checkNomValue()}},updateUiAfterSubmit:function(){const e=["selectedDate","reDelPointID","dnqGSA","uomInput","eventInput","contractID","materialID","docTypeID","IdPubNomDelvPointInput","IdPubNomDNQInput","IdPubNomUOMInput","IdPubNomEventSelect"];e.forEach(e=>{if(e){I.byId(e).setValue("")}});let t=I.getModel("tktModel");t.setData([]);let a=I.byId("parameterList");let o=a.getModel("serviceProfData");o.setProperty("/parameters",[]);if(this.myChart){this.myChart.destroy();this.myChart=null}let s=I.byId("chartContainer");s.destroyItems()},checkNomValue:async function(e){try{let e=I.getModel("salesContractData");let t=e.getData();if(!h){sap.m.MessageBox.error("Please select a Gas Day!");return}let a=new Date;let o=a.toISOString();let s=h;let l=I.byId("contractID").getValue();let n=I.byId("dnqGSA").getValue();let i=I.byId("eventInput").getSelectedItem()&I.byId("eventInput").getSelectedItem().getText()||"";let r=new Date(e.getProperty("/ValidFrom"));let d=new Date(e.getProperty("/ValidTo"));let c=new Date(s);if(c<r||c>d){sap.m.MessageBox.error("The contract validity expired.");return}let u=new sap.ui.model.json.JSONModel;let m={Gasday:s,Vbeln:l,Posnr:t.ItemNo,Timestamp:o,Kunnr:t.Customer,Auart:t.Auart,Dcq:t.DCQ,PDnq:n,Event:i||"",deliveryPoint:t.DeliveryPt,Redelivery:t.RedeliveryPt,Material:t.Material};let g=await this.getPurchaseNumberFromPurchArray(l);if(g){await this.purchaseNomination(l,g)}else{u.setData(m);I.setModel(u,"nomination");let e=I.getModel("nomination").getData();let t=this.getOwnerComponent().getModel();let a=t.bindList("/xGMSxGMS_nom");let o=await a.create(e);console.log("Nomination created successfully:",o);sap.m.MessageBox.success("Nomination created successfully",{onClose:function(){this.updateUiAfterSubmit()}.bind(this)})}}catch(e){console.error("Error creating nomination:",e)}},getPurchaseNumberFromPurchArray:function(e){return new Promise((t,a)=>{let o=null;let s=y.find(t=>t.salesNumber===e);if(s){o=s.salesNumber}t(o)})},purchaseNomination:async function(e,t){try{let a=I.getModel("salesContractData");let o=a.getData();let s=h;let l=new Date;let n=l.toISOString();let i=y.filter(t=>t.salesNumber===e);if(i.length>0){let e=new sap.ui.model.json.JSONModel;let a=I.byId("dnqGSA").getValue();let l=I.byId("dnqGTA").getValue();let i=I.byId("eventInput").getSelectedItem()&I.byId("eventInput").getSelectedItem().getText()||"";let d=I.byId("eventInputGTA").getSelectedItem()&I.byId("eventInputGTA").getSelectedItem().getText()||"";let c=I.byId("remarks").getValue();let u=[{Gasday:s,Vbeln:t,Posnr:o.ItemNo,Timestamp:n,Kunnr:o.Customer,Auart:o.Auart,Dcq:o.DCQ,PDnq:a,Event:i||"",Redelivery:o.RedeliveryPt,Material:o.Material,Remarks:c},{Gasday:s,Vbeln:o.Vbeln_p,Posnr:o.ItemNo,Timestamp:n,Kunnr:o.Supplier,Auart:o.Auart,Dcq:o.DCQ,PDnq:l,Event:d||"",deliveryPoint:o.DeliveryPt,Material:o.Material,Remarks:c}];for(let t of u){e.setData(t);I.setModel(e,"purchase");let a=I.getModel("purchase").getData();let o=this.getOwnerComponent().getModel();let s=o.bindList("/xGMSxGMS_nom");await s.create(a,true)}console.log("Both nominations created successfully.");r.success("Nominations created successfully",{onClose:function(){this.onInit();location.reload()}.bind(this)})}}catch(e){console.error("Error creating nominations:",e);r.error("Failed to create nominations. Please try again.");throw e}},Onsimulate:function(){if(!this._simulateDialog){this._simulateDialog=sap.ui.xmlfragment("com.ingenx.nomination.salesnomination.fragment.simulatePopup",this);I.addDependent(this._simulateDialog)}this._simulateDialog.open();const e=I.byId("dnqGSA").getValue();const t=I.byId("selectedDate").getDateValue();this._addDNQPointToChart(e,t)},_addDNQPointToChart:function(e,t){const a=new Date(t);if(!this.myChart.data.datasets.some(e=>e.label==="DNQ")){this.myChart.data.datasets.push({label:"DNQ",data:[],borderColor:"red",pointBackgroundColor:"red",pointRadius:5,fill:false,showLine:false,yAxisID:"y1"})}const o=this.myChart.data.datasets.find(e=>e.label==="DNQ");o.data.push({x:a,y:e});this.myChart.update()},onCloseSimulateDialog:function(){this._simulateDialog.close()}})});
//# sourceMappingURL=publishNomination.controller copy.js.map