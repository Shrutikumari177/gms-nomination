sap.ui.define(["sap/ui/Device","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","com/ingenx/nomination/salesnomination/utils/HelperFunction","sap/m/Popover","sap/m/Button","sap/m/library","sap/viz/ui5/controls/common/feeds/FeedItem","sap/viz/ui5/data/FlattenedDataset","sap/m/MessageBox","sap/m/MessageToast","external/ChartJSAdapterDateFns","external/ChartJS"],function(e,t,a,i,o,l,s,n,r,d,c,u,m,g){"use strict";let y;let D;let h=Number.MAX_SAFE_INTEGER;let P=0;let v=0;let M;let V;return a.extend("com.ingenx.nomination.salesnomination.controller.publishNomination",{onInit:function(){D=this.getView();var e=new i({pane1:"200px",pane2:"auto",pane3:"auto"});D.setModel(e,"sizes");const t={DeliveryPoints:[{DeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}]};const a={RedeliveryPoints:[{RedeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}]};const o=new sap.ui.model.json.JSONModel(t);const l=new sap.ui.model.json.JSONModel(a);this.getView().setModel(o,"DelvModelData");this.getView().setModel(l,"RedlvModelData");var s=new sap.ui.model.json.JSONModel({CummDNQ:""});this.getView().setModel(s,"localModel");const n=this.byId("IdPubNomGasDayPicker");const r=new Date;const d=new Date(r);d.setDate(r.getDate()+1);n.setMinDate(d)},onRootContainerResize:function(e){var t=e.getParameter("oldSizes"),a=e.getParameter("newSizes"),i="Root container is resized.";if(t&&t.length){i+="\nOld panes sizes = ["+t+"]"}i+="\nNew panes sizes = ["+a+"]"},onInnerContainerResize:function(e){var t=e.getParameter("oldSizes"),a=e.getParameter("newSizes"),i="Inner container is resized.";if(t&&t.length){i+="\nOld panes sizes = ["+t+"]"}i+="\nNew panes sizes = ["+a+"]"},onTimeChange:function(e){var t=e.getParameter("value");var a=this.getView().getModel("RedlvModelData");a.setProperty(e.getSource().getBinding("value").getPath(),t)},soldToPartyValueHelp:async function(e){try{let t="_customerSelectDialog";let a="com.ingenx.nomination.salesnomination.fragment.soldToParty";this._currentValueHelpSource=e.getSource();await o._openValueHelpDialog(this,t,a)}catch(e){console.error("Error opening value help dialog:",e);sap.m.MessageBox.error("Could not open value help. Please contact support.")}},onValueHelpConfirmSTP:async function(e){try{let t=this._currentValueHelpSource;V=o._valueHelpSelectedValue(e,this,t.getId());if(!V)return;let a=this.getView();a.byId("IdPubNomContractsPage").setBusy(true);let i=await o._getSingleEntityDataWithParam(this,"getNominationsByCustomer","SoldToParty",V);if(i&&i.length){let e=new sap.ui.model.json.JSONModel({data:i});a.setModel(e,"newModelForContracts");a.getModel("newModelForContracts").refresh()}}catch(e){console.error("Unexpected error:",e.message||e);sap.m.MessageBox.error("An unexpected error occurred. Please try again.")}finally{this.getView().byId("IdPubNomContractsPage").setBusy(false);this._customerSelectDialog.getBinding("items").filter([])}},onValueHelpSearchSTP:function(e){o._valueHelpLiveSearch(e,"Customer","soldToParty",this)},onBackMat:function(){try{this.byId("IdPubNomStaticListS").setVisible(false);this.byId("IdPubNomContractRPDCQ").setVisible(true);this.byId("IdPubNomStaticListfinal").setVisible(true);const e=this.byId("IdPubNomVboxMaterials");const t=this.byId("IdPubNomVboxContracts");t.setVisible(true);e.setVisible(false);const a=this.byId("IdPubNomDelPointTable");if(a){a.setVisible(false);this.byId("IdPubNomTableHeaderBarForDelv").setVisible(false)}this.byId("IdDelCummDNQInput").setValue("");this.byId("IdCummDNQInput").setValue("");this.clearMaterialModels()}catch(e){console.error("Error in onBackMat:",e);sap.m.MessageToast.show("An error occurred while processing. Please try again.")}},clearMaterialModels:function(){const e=this.getView().getModel("materialModel");const t=this.getView().getModel("contDataModel");const a=this.getView().getModel("RedlvModelData");const i=this.getView().getModel("DelvModelData");if(t){t.setData({})}if(a){a.setProperty("/RedeliveryPoints",[{RedeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}])}if(i){i.setProperty("/DeliveryPoints",[{DeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}])}const o=this.byId("IdPubNomGasDayPicker");if(o){o.setValue("")}this.byId("IdDelCummDNQInput").setValue("");this.byId("IdCummDNQInput").setValue("");this.byId("IdPubNomStaticListS").setVisible(false);this.byId("IdPubNomContractRPDCQ").setVisible(true);this.byId("IdPubNomStaticListfinal").setVisible(true);this.refreshModels([e,t,a,i])},refreshModels:function(e){e.forEach(e=>{if(e){e.refresh(true)}})},onSelectContract:async function(e){const t=this.getView();const a=t.byId("IdPubNomContractsPage");const i=t.byId("IdPubNomVboxContracts");const o=t.byId("IdPubNomVboxMaterials");const l=this.getOwnerComponent().getModel();a.setBusy(true);i.setVisible(false);o.setVisible(true);try{M=e.getSource().getBindingContext("newModelForContracts").getObject();console.log("sContract",M);const a=`/getContractDetailsAndPastNom?DocNo=${M.DocNo}`;console.log("sPath",a);let i=this.getOwnerComponent().getModel();const o=i.bindContext(a,null,{});try{const e=await o.requestObject();console.log("Fetched Data:",e);let a=t.getModel("materialModel");if(!a){a=new sap.ui.model.json.JSONModel;t.setModel(a,"materialModel")}a.setProperty("/selectedMaterials",e.value);console.log("oMaterialModel",a)}catch(e){console.log("error",e)}}catch(e){console.error("Error fetching contract details:",e.message||e);sap.m.MessageBox.error("Failed to fetch contract details. Please try again later.")}finally{a.setBusy(false)}},onSelectMaterial:async function(e){let t=e.getSource();let a=t.getBindingContext("materialModel");if(!a)return;let i=a.getObject();let o=i.Material;let l=i.Redelivery_Point;const s=`/getContractDetail?DocNo=${M.DocNo}&Material=${o}&Redelivery_Point=${l}`;console.log("sPath",s);let n=this.getOwnerComponent().getModel();let r=n.bindContext(s,null,{});try{const e=await r.requestObject();console.log("Fetched Data:",e.value);let t=new sap.ui.model.json.JSONModel(e.value[0]);this.getView().setModel(t,"contDataModel");this._updateRedeliveryData(e.value[0]);this._updateDeliveryData(e.value[0])}catch(e){console.error("Error fetching contract details:",e)}},_updateRedeliveryData:function(e){const t=e.Redelivery_Point&&e.Redelivery_Point.trim()!=="";if(t){this.getView().byId("IdPubNomContractRPDCQ").setVisible(true);let t=this.getView().getModel("RedlvModelData");let a=t.getProperty("/RedeliveryPoints")||[];a.forEach(t=>{t.RedeliveryPt=e.Redelivery_Point;t.UOM="MBT"});t.setProperty("/RedeliveryPoints",a)}},_updateDeliveryData:function(e){const t=!!(e.Delivery_Point&&e.Delivery_Point.trim());if(t){let t=this.getView();t.byId("IdPubNomStaticListS").setVisible(true);t.byId("IdPubNomContratRPDCQ").setVisible(true);t.byId("IdPubNomContractDPDCQ").setVisible(true);t.byId("IdPubNomContractRPDCQ").setVisible(false);t.byId("IdPubNomStaticListfinal").setVisible(false);t.byId("IdPubNomDelPointTable").setVisible(true);let a=t.getModel("DelvModelData");let i=a.getProperty("/DeliveryPoints")||[];i.forEach(t=>{t.DeliveryPt=e.Delivery_Point;t.UOM="MBT"});a.setProperty("/DeliveryPoints",i)}},debounce:function(e,t){let a;return function(...i){clearTimeout(a);a=setTimeout(()=>e.apply(this,i),t)}},OnDeliveryDNQValidation:function(e){let t=e.getParameter("value").trim();let a=parseFloat(t)||0;let i=this.getView();let l=i.getModel("contDataModel").getData();let s=this._getClauseValue(l.data,"Max DP DCQ");let n=this._getClauseValue(l.data,"Min DP DCQ");let r={DNQ:a,"Max DCQ":s,"Min DCQ":n};if(this._validationTimeout){clearTimeout(this._validationTimeout)}if(t===""){this._lastValidatedValue=null;return}if(!this._lastValidatedValue||this._lastValidatedValue!==t){this._lastValidatedValue=t;this._validationTimeout=setTimeout(async()=>{if(t.length>=1){try{await o.validateDNQ(i,r,V)}catch(e){console.error("Validation failed:",e)}finally{this._validationTimeout=null}}},1e3)}},OnReDeliveryDNQValidation:function(e){let t=e.getParameter("value").trim();let a=parseFloat(t)||0;let i=this.getView();let l=i.getModel("localModel");l.setProperty("/CummDNQ",t?t+"MBT":"");let s=i.getModel("contDataModel").getData();let n=this._getClauseValue(s.data,"Max RDP DCQ");let r=this._getClauseValue(s.data,"Min RDP DCQ");let d={DNQ:a,"Max DCQ":n,"Min DCQ":r};if(this._validationTimeout){clearTimeout(this._validationTimeout)}if(t===""){this._lastValidatedValue=null;return}if(!this._lastValidatedValue||this._lastValidatedValue!==t){this._lastValidatedValue=t;this._validationTimeout=setTimeout(async()=>{if(t.length>=1){try{await o.validateDNQ(i,d,V)}catch(e){console.error("Validation failed:",e)}finally{this._validationTimeout=null}}},1e3)}},_getClauseValue:function(e,t){let a=e.find(e=>e.Clause_Code===t);return a?parseFloat(a.Calculated_Value)||0:0},calculateDCQStatsByLabels:function(e,t){if(e.length===0){return}for(let t=0;t<e.length;t++){const a=e[t].value;P=Math.max(P,a);h=Math.min(h,a)}v=P},onSelectedDate:function(){var e=this.getView().byId("IdPubNomGasDayPicker");var t=e.getDateValue();console.log("sDate",t)},onChangeAddDecimal:function(e){var t=e.getSource();var a=t.getValue().trim();var i=parseFloat(a);if(!a){t.setValue("0.000");return}if(!isNaN(i)){var o=i.toFixed(3);t.setValue(o);var l=t.getBinding("value")?t.getBinding("value").getPath():null;var s=t.getModel();if(s&&l){s.setProperty(l,o)}}else{t.setValue("0.000")}},createNomination:async function(){try{let e=this.getView().byId("IdPubNomGasDayPicker").getDateValue();const t=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});e=t.format(e);if(!e){sap.m.MessageBox.error("Please select a Gas Day!");return}const a=this.getView().getModel("RedlvModelData").getData();const i=this.getView().getModel("DelvModelData").getData();const o=this.getView().getModel("contDataModel").getData();let l=[];if(o.Delivery_Point){l.push({Gasday:e,Vbeln:o.DocNo,ItemNo:"10",NomItem:"10",Versn:"",DeliveryPoint:o.Delivery_Point,RedelivryPoint:"",ValidTo:i.DeliveryPoints[0].ToT,ValidFrom:i.DeliveryPoints[0].FromT,Material:o.Material,Kunnr:"",Auart:"ZGSA",Ddcq:o.Delivery_Dcq,Uom1:i.DeliveryPoints[0].UOM,Pdnq:i.DeliveryPoints[0].DNQ,Event:i.DeliveryPoints[0].Event,Adnq:"0.000",Znomtk:"",Src:"",Remarks:"",Flag:"",Action:"",Path:"",CustGrp:"",SrvProfile:""});l.push({Gasday:e,Vbeln:o.DocNo,ItemNo:"10",NomItem:"20",Versn:"",DeliveryPoint:"",RedelivryPoint:o.Redelivery_Point,ValidTo:a.RedeliveryPoints[0].ToT,ValidFrom:a.RedeliveryPoints[0].FromT,Material:o.Material,Kunnr:"",Auart:"ZGSA",Ddcq:"0.000",Rdcq:o.Redelivery_Dcq,Uom1:a.RedeliveryPoints[0].UOM,Event:a.RedeliveryPoints[0].Event,Adnq:"0.000",Rpdnq:a.RedeliveryPoints[0].DNQ,Znomtk:"",Src:"",Remarks:"",Flag:"",Action:"",Path:"",CustGrp:"",SrvProfile:""})}else{l.push({Gasday:e,Vbeln:o.DocNo,ItemNo:"10",NomItem:"10",Versn:"",DeliveryPoint:"",RedelivryPoint:o.Redelivery_Point,ValidTo:a.RedeliveryPoints[0].ToT,ValidFrom:a.RedeliveryPoints[0].FromT,Material:o.Material,Kunnr:"",Auart:"ZGSA",Ddcq:"0.000",Rdcq:o.Redelivery_Dcq,Uom1:a.RedeliveryPoints[0].UOM,Event:a.RedeliveryPoints[0].Event,Adnq:"0.000",Rpdnq:a.RedeliveryPoints[0].DNQ,Znomtk:"",Src:"",Remarks:"",Flag:"",Action:"",Path:"",CustGrp:"",SrvProfile:""})}console.log("nomi_toitem",l);let s={Gasday:e,Vbeln:o.DocNo,nomi_toitem:l};let n=this.getOwnerComponent().getModel();let r=n.bindList("/znom_headSet");const d=await r.create(s,true);await d.created();sap.m.MessageBox.success("Nomination Successfully Submitted");this.clearMaterialModels()}catch(e){console.error("Error creating nomination:",e);sap.m.MessageBox.error("Failed to submit nomination. Please try again.")}},onCloseSimulateDialog:function(){this._simulateDialog.close()},Onsimulate:function(){if(!this._simulateDialog){this._simulateDialog=sap.ui.xmlfragment("com.ingenx.nomination.salesnomination.fragment.simulatePopup",this);this.getView().addDependent(this._simulateDialog)}this._simulateDialog.open();const e=this.getView().byId("dnqGSA").getValue();const t=this.getView().byId("selectedDate").getDateValue();sap.ui.getCore().getEventBus().publish("chartUpdate","addDNQPoint",{dnq:Number(e),gasDay:t})}})});
//# sourceMappingURL=publishNomination.controller.js.map