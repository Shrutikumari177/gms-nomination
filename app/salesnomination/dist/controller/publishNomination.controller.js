sap.ui.define(["sap/ui/Device","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","com/ingenx/nomination/salesnomination/utils/HelperFunction","sap/m/Popover","sap/m/Button","sap/m/library","sap/viz/ui5/controls/common/feeds/FeedItem","sap/viz/ui5/data/FlattenedDataset","sap/m/MessageBox","sap/m/MessageToast","external/ChartJSAdapterDateFns","external/ChartJS"],function(e,t,a,o,i,l,n,s,r,d,c,u,m,g){"use strict";let D;let y;let p;let h;let P;let M;let v;let V;return a.extend("com.ingenx.nomination.salesnomination.controller.publishNomination",{onInit:function(){h=this.getView();var e=new o({pane1:"200px",pane2:"auto",pane3:"auto"});h.setModel(e,"sizes");const t={DeliveryPoints:[{DeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}]};const a={RedeliveryPoints:[{RedeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}]};const i=new sap.ui.model.json.JSONModel(t);const l=new sap.ui.model.json.JSONModel(a);this.getView().setModel(i,"DelvModelData");this.getView().setModel(l,"RedlvModelData");var n=new sap.ui.model.json.JSONModel({rdpCummDNQ:"",dpCummDNQ:""});this.getView().setModel(n,"localModel");const s=this.byId("IdPubNomGasDayPicker");const r=new Date;const d=new Date(r);d.setDate(r.getDate()+1);s.setMinDate(d)},onRootContainerResize:function(e){var t=e.getParameter("oldSizes"),a=e.getParameter("newSizes"),o="Root container is resized.";if(t&&t.length){o+="\nOld panes sizes = ["+t+"]"}o+="\nNew panes sizes = ["+a+"]"},onInnerContainerResize:function(e){var t=e.getParameter("oldSizes"),a=e.getParameter("newSizes"),o="Inner container is resized.";if(t&&t.length){o+="\nOld panes sizes = ["+t+"]"}o+="\nNew panes sizes = ["+a+"]"},onTimeChange:function(e){var t=e.getParameter("value");var a=this.getView().getModel("RedlvModelData");a.setProperty(e.getSource().getBinding("value").getPath(),t)},soldToPartyValueHelp:async function(e){try{let t="_customerSelectDialog";let a="com.ingenx.nomination.salesnomination.fragment.soldToParty";this._currentValueHelpSource=e.getSource();await i._openValueHelpDialog(this,t,a)}catch(e){console.error("Error opening value help dialog:",e);sap.m.MessageBox.error("Could not open value help. Please contact support.")}},onValueHelpConfirmSTP:async function(e){try{let t=this._currentValueHelpSource;M=i._valueHelpSelectedValue(e,this,t.getId());if(!M)return;let a=this.getView();a.byId("IdPubNomContractsPage").setBusy(true);let o=await i._getSingleEntityDataWithParam(this,"getNominationsByCustomer","SoldToParty",M);if(o&&o.length){let e=new sap.ui.model.json.JSONModel({data:o});a.setModel(e,"newModelForContracts");a.getModel("newModelForContracts").refresh()}}catch(e){console.error("Unexpected error:",e.message||e);sap.m.MessageBox.error("An unexpected error occurred. Please try again.")}finally{this.getView().byId("IdPubNomContractsPage").setBusy(false);this._customerSelectDialog.getBinding("items").filter([])}},onValueHelpSearchSTP:function(e){i._valueHelpLiveSearch(e,["Customer","CustomerName"],"soldToParty",this)},onBackMat:function(){try{this.byId("IdPubNomStaticListS").setVisible(false);this.byId("IdPubNomContractRPDCQ").setVisible(true);this.byId("IdPubNomStaticListfinal").setVisible(true);const e=this.byId("IdPubNomVboxMaterials");const t=this.byId("IdPubNomVboxContracts");t.setVisible(true);e.setVisible(false);const a=this.byId("IdPubNomDelPointTable");if(a){a.setVisible(false);this.byId("IdPubNomTableHeaderBarForDelv").setVisible(false)}this.byId("IdDelCummDNQInput").setValue("");this.byId("IdCummDNQInput").setValue("");const o=this.byId("IdPubNomChartContainer");if(o){o.removeAllItems()}this.clearMaterialModels()}catch(e){console.error("Error in onBackMat:",e);sap.m.MessageToast.show("An error occurred while processing. Please try again.")}},clearMaterialModels:function(){const e=this.getView().getModel("materialModel");const t=this.getView().getModel("contDataModel");const a=this.getView().getModel("RedlvModelData");const o=this.getView().getModel("DelvModelData");const i=this.getView().getModel("pastNomModel");if(t){t.setData({})}if(i){i.setData({})}if(a){a.setProperty("/RedeliveryPoints",[{RedeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}])}if(o){o.setProperty("/DeliveryPoints",[{DeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}])}const l=this.byId("IdPubNomGasDayPicker");if(l){l.setValue("")}this.byId("IdDelCummDNQInput").setValue("");this.byId("IdCummDNQInput").setValue("");this.byId("IdPubNomStaticListS").setVisible(false);this.byId("IdPubNomContractRPDCQ").setVisible(true);this.byId("IdPubNomStaticListfinal").setVisible(true);this.refreshModels([e,t,a,o,i])},refreshModels:function(e){e.forEach(e=>{if(e){e.refresh(true)}})},onSelectContract:async function(e){const t=this.getView();const a=t.byId("IdPubNomContractsPage");const o=t.byId("IdPubNomVboxContracts");const i=t.byId("IdPubNomVboxMaterials");const l=this.getOwnerComponent().getModel();a.setBusy(true);o.setVisible(false);i.setVisible(true);try{P=e.getSource().getBindingContext("newModelForContracts").getObject();console.log("sContract",P);const a=String(P.DocNo);const o=`/getContractDetailsAndPastNom?DocNo='${encodeURIComponent(a)}'`;console.log("sPath",o);let i=this.getOwnerComponent().getModel();const l=i.bindContext(o,null,{});try{const e=await l.requestObject();console.log("Fetched Data:",e);let a=t.getModel("materialModel");if(!a){a=new sap.ui.model.json.JSONModel;t.setModel(a,"materialModel")}a.setProperty("/selectedMaterials",e.value);console.log("oMaterialModel",a)}catch(e){console.log("error",e)}}catch(e){console.error("Error fetching contract details:",e.message||e);sap.m.MessageBox.error("Failed to fetch contract details. Please try again later.")}finally{a.setBusy(false)}},onSelectMaterial:async function(e){let t=e.getSource();let a=t.getBindingContext("materialModel");if(!a)return;let o=a.getObject();D=String(o.Material);y=String(o.Redelivery_Point);p=String(P.DocNo);const i=`/getContractDetail?DocNo='${encodeURIComponent(p)}'&Material='${encodeURIComponent(D)}'&Redelivery_Point='${encodeURIComponent(y)}'`;console.log("sPath",i);let l=this.getOwnerComponent().getModel();let n=l.bindContext(i,null,{});if(!this._oBusyDialog){this._oBusyDialog=new sap.m.BusyDialog({text:"Loading nomination details...",title:"Please wait"})}this._oBusyDialog.open();try{const e=await n.requestObject();console.log("Fetched Data:",e.value);let t=new sap.ui.model.json.JSONModel(e.value[0]);this.getView().setModel(t,"contDataModel");this._updateRedeliveryData(e.value[0]);this._updateDeliveryData(e.value[0]);this.fetchPastNominationData(p,D)}catch(e){console.error("Error fetching contract details:",e);sap.m.MessageToast.show("Failed to load contract details.")}finally{this._oBusyDialog.close()}},onSelectedGasDay:async function(e){const t=e.getSource();const a=t.getDateValue();if(!a)return;const o=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});let i=o.format(a);const l=`/getMinMaxDCQByGasDate?DocNo='${encodeURIComponent(p)}'&Material='${encodeURIComponent(D)}'&Redelivery_Point='${encodeURIComponent(y)}'&Gasday=${i}`;let n=this.getOwnerComponent().getModel();let s=n.bindContext(l,null,{});try{const e=await s.requestObject();let t=this.getView().getModel("contDataModel");if(t){let a=t.getData();a.data=e.value;t.setData(a)}else{let t=new sap.ui.model.json.JSONModel({data:e.value});this.getView().setModel(t,"contDataModel")}}catch(e){const t=e?.message||"Unknown error occurred.";if(t.includes("No clause found")||t.includes("DCQ Validity starts from")){const e=[{Clause_Code:"Max RDP DCQ",Calculated_Value:""},{Clause_Code:"Min RDP DCQ",Calculated_Value:""}];let a=this.getView().getModel("contDataModel");if(a){let t=a.getData();t.data=e;a.setData(t)}else{let t=new sap.ui.model.json.JSONModel({data:e});this.getView().setModel(t,"contDataModel")}sap.m.MessageBox.error(t)}else{console.error("Error fetching clause codes:",e);sap.m.MessageBox.error(t)}}},fetchPastNominationData:async function(e,t){let a=`/getPastNominationdata?DocNo='${encodeURIComponent(e)}'&Material='${encodeURIComponent(t)}'`;console.log("Fetching past nomination data from:",a);let o=this.getOwnerComponent().getModel();let i=o.bindContext(a,null,{});try{const e=await i.requestObject();console.log("Past Nomination Data:",e.value);let t=new sap.ui.model.json.JSONModel(e.value||[]);this.getView().setModel(t,"pastNomModel");this._createPastNominationChart()}catch(e){console.error("Error fetching past nomination data:",e);sap.m.MessageToast.show("Failed to load past nomination data.")}},_createPastNominationChart:function(){const e=this.getView();const t=e.byId("IdPubNomChartContainer");const a=e.getModel("pastNomModel").getData();const o=e.getModel("contDataModel").getData();const i=parseFloat(this._getClauseValue(o.data,"Max RDP DCQ"));const l=parseFloat(this._getClauseValue(o.data,"Min RDP DCQ"));const n=parseFloat(o.Redelivery_Dcq);const s=a.map(e=>({Validity:e.Gasday,Adnq:parseFloat(e.Adnq),MaxDCQ:i,MinDCQ:l,DCQ:n}));const r=new sap.ui.model.json.JSONModel({data:s});t.removeAllItems();const d=new sap.viz.ui5.controls.VizFrame({width:"100%",height:"350px",vizType:"line"});const c=new sap.viz.ui5.data.FlattenedDataset({dimensions:[{name:"Validity",value:"{Validity}"}],measures:[{name:"DCQ",value:"{DCQ}"},{name:"Min DCQ",value:"{MinDCQ}"},{name:"Max DCQ",value:"{MaxDCQ}"},{name:"Adnq",value:"{Adnq}"}],data:{path:"/data"}});d.setDataset(c);d.setModel(r);d.setVizProperties({title:{visible:false},plotArea:{dataLabel:{visible:false},line:{dataShape:{Adnq:"line_with_marker",DCQ:"line","Min DCQ":"line","Max DCQ":"line"}},referenceLine:{line:{valueAxis:[{value:n,color:"#107e3e",lineType:"dashed"},{value:l,color:"#00bce1",lineType:"dashed"},{value:i,color:"purple",lineType:"dashed"}]}}},valueAxis:{title:{visible:true,text:"DCQ Values"},label:{formatString:"#,##0"}},categoryAxis:{title:{visible:true,text:"Validity"},label:{formatString:"MMM-yyyy"}},legend:{visible:true},tooltip:{visible:true,formatString:"#,##0.00"}});d.setVizScales([{feed:"color",palette:["#107e3e","#00bce1","purple","blue"]}]);d.addFeed(new sap.viz.ui5.controls.common.feeds.FeedItem({uid:"valueAxis",type:"Measure",values:["DCQ","Min DCQ","Max DCQ","Adnq"]}));d.addFeed(new sap.viz.ui5.controls.common.feeds.FeedItem({uid:"categoryAxis",type:"Dimension",values:["Validity"]}));t.addItem(d);d.attachEventOnce("renderComplete",function(){try{const e=d.getDomRef();const t=e.querySelectorAll("g.v-category-axis text");const a=Array.from(t).map(e=>e.textContent.trim());const o=a.map(e=>({value:e,color:"#e0e0e0",lineType:"dotted",size:1,label:{visible:false}}));const i=d.getVizProperties();i.plotArea.referenceLine.line.categoryAxis=o;d.setVizProperties(i)}catch(e){console.warn("Could not set vertical grid lines: ",e)}})},_updateRedeliveryData:function(e){const t=e.Redelivery_Point&&e.Redelivery_Point.trim()!=="";if(t){this.getView().byId("IdPubNomContractRPDCQ").setVisible(true);let t=this.getView().getModel("RedlvModelData");let a=t.getProperty("/RedeliveryPoints")||[];a.forEach(t=>{t.RedeliveryPt=e.Redelivery_Point;t.UOM="MBT"});t.setProperty("/RedeliveryPoints",a)}},_updateDeliveryData:function(e){const t=!!(e.Delivery_Point&&e.Delivery_Point.trim());if(t){let t=this.getView();t.byId("IdPubNomStaticListS").setVisible(true);t.byId("IdPubNomContratRPDCQ").setVisible(true);t.byId("IdPubNomContractDPDCQ").setVisible(true);t.byId("IdPubNomContractRPDCQ").setVisible(false);t.byId("IdPubNomStaticListfinal").setVisible(false);t.byId("IdPubNomDelPointTable").setVisible(true);t.byId("IdPubNomTableHeaderBarForDelv").setVisible(true);let a=t.getModel("DelvModelData");let o=a.getProperty("/DeliveryPoints")||[];o.forEach(t=>{t.DeliveryPt=e.Delivery_Point;t.UOM="MBT"});a.setProperty("/DeliveryPoints",o)}},debounce:function(e,t){let a;return function(...o){clearTimeout(a);a=setTimeout(()=>e.apply(this,o),t)}},OnDeliveryDNQValidation:function(e){let t=e.getParameter("value").trim();let a=parseFloat(t)||0;let o=this.getView();let l=o.getModel("localModel");if(!t){l.setProperty("/dpCummDNQ","");this._lastValidatedValue=null;return}l.setProperty("/dpCummDNQ",t+"MBT");let n=o.getModel("contDataModel").getData();let s=n.Profile;let r=this._getClauseValue(n.data,"Max DP DCQ");let d=this._getClauseValue(n.data,"Min DP DCQ");let u={DNQ:a,"Max DP DCQ":r,"Min DP DCQ":d};let m=V==="Force-Majeure"||V==="Under-Maintenance";if(this._validationTimeout){clearTimeout(this._validationTimeout)}if(!this._lastValidatedValue||this._lastValidatedValue!==t){this._lastValidatedValue=t;this._validationTimeout=setTimeout(async()=>{if(t.length>=1){try{let t=await i.validateDNQ(o,u,M,s,m);if(!t.isValid){c.error(t.message,{onClose:()=>{e.getSource().setValue("");l.setProperty("/dpCummDNQ","")}})}}catch(t){console.error("Validation failed:",t);c.error("Validation error occurred.",{onClose:()=>{e.getSource().setValue("");l.setProperty("/dpCummDNQ","")}})}finally{this._validationTimeout=null}}},1e3)}},RDPeventSelected:function(e){let t=e.getSource().getSelectedItem();if(t){v=t.getText();return v}},DpEventSelected:function(e){let t=e.getSource().getSelectedItem();if(t){V=t.getText();return V}},OnReDeliveryDNQValidation:function(e){let t=e.getParameter("value").trim();let a=parseFloat(t)||0;let o=this.getView();let l=o.getModel("localModel");if(!t){l.setProperty("/rdpCummDNQ","");this._lastValidatedValue=null;return}l.setProperty("/rdpCummDNQ",t+"MBT");let n=o.getModel("contDataModel").getData();let s=n.Profile;let r=this._getClauseValue(n.data,"Max RDP DCQ");let d=this._getClauseValue(n.data,"Min RDP DCQ");let u={DNQ:a,"Max RDP DCQ":r,"Min RDP DCQ":d};let m=v==="Force-Majeure"||v==="Under-Maintenance";if(this._validationTimeout){clearTimeout(this._validationTimeout)}if(!this._lastValidatedValue||this._lastValidatedValue!==t){this._lastValidatedValue=t;this._validationTimeout=setTimeout(async()=>{if(t.length>=1){try{let t=await i.validateDNQ(o,u,M,s,m);if(!t.isValid){c.error(t.message,{onClose:()=>{e.getSource().setValue("");l.setProperty("/rdpCummDNQ","")}})}}catch(t){console.error("Validation failed:",t);c.error("Validation error occurred.",{onClose:()=>{e.getSource().setValue("");l.setProperty("/rdpCummDNQ","")}})}finally{this._validationTimeout=null}}},1e3)}},_getClauseValue:function(e,t){let a=e.find(e=>e.Clause_Code===t);return a?parseFloat(a.Calculated_Value)||0:0},onSelectedDate:function(){var e=this.getView().byId("IdPubNomGasDayPicker");var t=e.getDateValue();console.log("sDate",t)},createNomination:async function(){let e=new sap.m.BusyDialog;try{e.open();let t=this.getView().byId("IdPubNomGasDayPicker");let a=t?t.getDateValue():null;let o=this.getView().byId("IdPubNomRemarksInput").getValue();console.log("Remarks",o);if(!a){e.close();sap.m.MessageBox.error("Please select a Gas Day!");return}const i=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});a=i.format(a);const l=this.getView().getModel("RedlvModelData").getData();const n=this.getView().getModel("DelvModelData").getData();const s=this.getView().getModel("contDataModel").getData();if(!s||!s.DocNo){e.close();sap.m.MessageBox.error("Invalid contract data. Please check and try again.");return}let r=[];let d=this.getOwnerComponent().getModel();let c=s.DocNo;try{let e=d.bindContext(`/TransAgreemSet(Salescontract='${s.DocNo}')`);let t=await e.requestObject();if(t&&t.Purchasecontract){c=t.Purchasecontract}}catch(e){console.log("Failed to fetch Purchase Contract:",e)}if(s.Delivery_Point){r.push({Contracttype:s.Contracttype,Source:"Manual",Gasday:a,Vbeln:c,ItemNo:"10",NomItem:"20",Shiptoparty:M,Vendor:s.Vendor,Versn:"",DeliveryPoint:s.Delivery_Point,RedelivryPoint:"",ValidTo:n.DeliveryPoints[0].ToT,ValidFrom:n.DeliveryPoints[0].FromT,Material:s.Material,kunnr:"",Auart:s.Auart,Ddcq:s.Delivery_Dcq,Uom1:n.DeliveryPoints[0].UOM,Pdnq:n.DeliveryPoints[0].DNQ,Event:n.DeliveryPoints[0].Event,Adnq:"0.000",Nomtk:"0.000",Znomtk:"",Src:"",Remarks:o,Flag:"",Action:"",Path:"",CustGrp:"",SrvProfile:s.Profile});r.push({Contracttype:s.Contracttype,Source:"Manual",Gasday:a,Vbeln:s.DocNo,ItemNo:"10",NomItem:"10",Shiptoparty:M,Vendor:s.Vendor,Versn:"",DeliveryPoint:"",RedelivryPoint:s.Redelivery_Point,ValidTo:l.RedeliveryPoints[0].ToT,ValidFrom:l.RedeliveryPoints[0].FromT,Material:s.Material,kunnr:"",Auart:s.Auart,Ddcq:"0.000",Rdcq:s.Redelivery_Dcq,Uom1:l.RedeliveryPoints[0].UOM,Event:l.RedeliveryPoints[0].Event,Adnq:"0.000",Nomtk:"0.000",Pdnq:l.RedeliveryPoints[0].DNQ,Znomtk:"",Src:"",Remarks:o,Flag:"",Action:"",Path:"",CustGrp:"",SrvProfile:s.Profile})}else{r.push({Contracttype:s.Contracttype,Source:"Manual",Gasday:a,Vbeln:s.DocNo,ItemNo:"10",NomItem:"10",Shiptoparty:M,Vendor:s.Vendor,Versn:"",DeliveryPoint:"",RedelivryPoint:s.Redelivery_Point,ValidTo:l.RedeliveryPoints[0].ToT,ValidFrom:l.RedeliveryPoints[0].FromT,Material:s.Material,kunnr:"",Auart:s.Auart,Ddcq:"0.000",Rdcq:s.Redelivery_Dcq,Uom1:l.RedeliveryPoints[0].UOM,Event:l.RedeliveryPoints[0].Event,Adnq:"0.000",Nomtk:"0.000",Pdnq:l.RedeliveryPoints[0].DNQ,Znomtk:"",Src:"",Remarks:o,Flag:"",Action:"",Path:"",CustGrp:"",SrvProfile:s.Profile})}console.log("Nomination Items:",r);let u={Gasday:a,Vbeln:s.DocNo,nomi_toitem:r};let m=this.getOwnerComponent().getModel();let g=m.bindList("/znom_headSet");const D=await g.create(u,true);await D.created();sap.m.MessageBox.success("Nomination Successfully Submitted");this.clearMaterialModels()}catch(e){console.error("Error creating nomination:",e);sap.m.MessageBox.error("Failed to submit nomination. Please try again.")}finally{e.close()}},onCloseSimulateDialog:function(){this._simulateDialog.close()},Onsimulate:function(){if(!this._simulateDialog){this._simulateDialog=sap.ui.xmlfragment("com.ingenx.nomination.salesnomination.fragment.simulatePopup",this);this.getView().addDependent(this._simulateDialog)}this._simulateDialog.open();const e=this.getView().byId("dnqGSA").getValue();const t=this.getView().byId("selectedDate").getDateValue();sap.ui.getCore().getEventBus().publish("chartUpdate","addDNQPoint",{dnq:Number(e),gasDay:t})}})});
//# sourceMappingURL=publishNomination.controller.js.map