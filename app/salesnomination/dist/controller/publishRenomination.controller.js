sap.ui.define(["sap/ui/Device","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/Popover","sap/m/Button","sap/m/library","sap/viz/ui5/controls/common/feeds/FeedItem","sap/viz/ui5/data/FlattenedDataset","sap/m/MessageBox","sap/m/MessageToast","external/ChartJSAdapterDateFns","external/ChartJS","com/ingenx/nomination/salesnomination/utils/HelperFunction"],function(e,t,i,o,a,s,l,n,r,d,c,u,y,m){"use strict";let D=undefined;let v=undefined;let g;let P;let h;return i.extend("com.ingenx.nomination.salesnomination.controller.publishRenomination",{onInit:function(){g=this.getView();var e=new o({pane1:"200px",pane2:"auto",pane3:"auto"});g.setModel(e,"sizes");const t={DeliveryPoints:[{DeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}]};const i={RedeliveryPoints:[{RedeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}]};const a=new sap.ui.model.json.JSONModel(t);const s=new sap.ui.model.json.JSONModel(i);this.getView().setModel(a,"DelvModelData");this.getView().setModel(s,"RedlvModelData");var l=new sap.ui.model.json.JSONModel({CummDNQ:""});this.getView().setModel(l,"localModel");const n=this.byId("IdRePubNomGasDayPicker");const r=new Date;const d=new Date(r);d.setDate(r.getDate()+1);n.setMinDate(d)},onRootContainerResize:function(e){var t=e.getParameter("oldSizes"),i=e.getParameter("newSizes"),o="Root container is resized.";if(t&&t.length){o+="\nOld panes sizes = ["+t+"]"}o+="\nNew panes sizes = ["+i+"]"},onInnerContainerResize:function(e){var t=e.getParameter("oldSizes"),i=e.getParameter("newSizes"),o="Inner container is resized.";if(t&&t.length){o+="\nOld panes sizes = ["+t+"]"}o+="\nNew panes sizes = ["+i+"]"},onLoadContractModel:async function(){let e=new sap.ui.model.json.JSONModel;g.setModel(e,"salesContractData")},soldToPartyValueHelp:async function(e){try{let t="_soldTopartySelectDialog";let i="com.ingenx.nomination.salesnomination.fragment.soldToParty";this._currentValueHelpSource=e.getSource();await m._openValueHelpDialog(this,t,i)}catch(e){console.error("Error opening value help dialog:",e);sap.m.MessageBox.error("Could not open value help. Please contact support.")}},onValueHelpConfirmSTP:async function(e){try{let t=this._currentValueHelpSource;h=m._valueHelpSelectedValue(e,this,t.getId());if(!h)return;let i=this.getView();i.byId("pubNom_Contracts").setBusy(true);let o=await m._getSingleEntityDataWithParam(this,"getNominationsByCustomer","SoldToParty",h);if(o&&o.length){let e=new sap.ui.model.json.JSONModel({data:o});i.setModel(e,"newModelForContracts");i.getModel("newModelForContracts").refresh();this.byId("datePicker").setVisible(true)}}catch(e){console.error("Unexpected error:",e.message||e);sap.m.MessageBox.error("An unexpected error occurred. Please try again.")}finally{g.byId("pubNom_Contracts").setBusy(false);if(this._customerSelectDialog){let e=this._customerSelectDialog.getBinding("items");if(e){e.filter([])}}}},onValueHelpSearchSTP:function(e){m._valueHelpLiveSearch(e,"Customer","soldToParty",this)},onBackMat:function(){try{this.byId("IdRePubNomStaticListS").setVisible(false);this.byId("IdRePubNomContractRPDCQ").setVisible(true);this.byId("IdRePubNomStaticListfinal").setVisible(true);var e=this.byId("VboxCon");e.setVisible(true);var t=this.byId("VboxMat");t.setVisible(false);const i=this.byId("IdRePubNomDelPointTable");if(i){i.setVisible(false);this.byId("IdRePubNomTableHeaderBarForDelv").setVisible(false)}this.byId("IdDelCummDNQInput").setValue("");this.byId("IdCummDNQInput").setValue("");this.clearMaterialModels()}catch(e){console.error("Error in onBackMat:",e);sap.m.MessageToast.show("An error occurred while processing. Please try again.")}},refreshModels:function(e){e.forEach(e=>{if(e){e.refresh(true)}})},clearMaterialModels:function(){const e=this.getView().getModel("materialModel");const t=this.getView().getModel("contDataModel");const i=this.getView().getModel("RedlvModelData");const o=this.getView().getModel("DelvModelData");if(t){t.setData({})}if(i){i.setProperty("/RedeliveryPoints",[{RedeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}])}if(o){o.setProperty("/DeliveryPoints",[{DeliveryPt:"",DNQ:"",UOM:"",FromT:"06:00:00",ToT:"06:00:00",Event:""}])}if(e){e.setData({})}const a=this.byId("IdRePubNomGasDayPicker");if(a){a.setValue("")}this.byId("IdDelCummDNQInput").setValue("");this.byId("IdCummDNQInput").setValue("");this.byId("IdRePubNomStaticListS").setVisible(false);this.byId("IdRePubNomContractRPDCQ").setVisible(true);this.byId("IdRePubNomStaticListfinal").setVisible(true);this.refreshModels([e,t,i,o])},onSelectContract:function(e){v=e.getSource().getBindingContext("newModelForContracts").getObject();v=v.DocNo;this.fetchNominationsDetails(v,D)},onSelectGasDay:function(e){const t=g.byId("datePicker");let i=t.getDateValue();if(i){const e=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyy-MM-dd"});D=e.format(i);console.log("Selected Date in format YYYY:mm:DD: ",i)}this.fetchNominationsDetails(v,D)},fetchNominationsDetails:async function(e,t){if(!e){sap.m.MessageToast.show("Please select a contract.");return}if(!t){sap.m.MessageToast.show("Please select a date before choosing a contract.");return}const i=this.getView();const o=i.byId("pubNom_Contracts");const a=i.byId("VboxCon");const s=i.byId("VboxMat");o.setBusy(true);a.setVisible(false);s.setVisible(true);let l=this.getOwnerComponent().getModel();try{const o=`/getContractMatDetailsByGasday?DocNo=${encodeURIComponent(e)}&Gasday=${encodeURIComponent(t)}`;const a=l.bindList(o);const s=await a.requestContexts(0,Infinity);const n=s.map(e=>e.getObject());console.log("aContracts",n);if(!n||n.length===0){sap.m.MessageToast.show("No nominations found for the selected contract.");return}let r=i.getModel("materialModel");if(!r){r=new sap.ui.model.json.JSONModel;i.setModel(r,"materialModel")}r.setProperty("/selectedMaterials",n)}catch(e){console.error("Error fetching contract details:",e.message||e);sap.m.MessageBox.error("Failed to fetch contract details. Please try again later.")}finally{o.setBusy(false)}},debounce:function(e,t){let i;return function(...o){clearTimeout(i);i=setTimeout(()=>e.apply(this,o),t)}},_getClauseValue:function(e,t){let i=e.find(e=>e.Clause_Code===t);return i?parseFloat(i.Calculated_Value)||0:0},OnDeliveryDNQValidation:function(e){let t=e.getParameter("value").trim();let i=parseFloat(t)||0;let o=this.getView();let a=o.getModel("contDataModel").getData();let s=this._getClauseValue(a.data,"Max DP DCQ");let l=this._getClauseValue(a.data,"Min DP DCQ");let n={DNQ:i,"Max DCQ":s,"Min DCQ":l};if(this._validationTimeout){clearTimeout(this._validationTimeout)}if(t===""){this._lastValidatedValue=null;return}if(!this._lastValidatedValue||this._lastValidatedValue!==t){this._lastValidatedValue=t;this._validationTimeout=setTimeout(async()=>{if(t.length>=2){try{await m.validateDNQ(o,n,h)}catch(e){console.error("Validation failed:",e)}finally{this._validationTimeout=null}}},1e3)}},OnReDeliveryDNQValidation:function(e){let t=e.getParameter("value").trim();let i=parseFloat(t)||0;let o=this.getView();let a=o.getModel("localModel");a.setProperty("/CummDNQ",t?t+"MBT":"");let s=o.getModel("contDataModel").getData();let l=this._getClauseValue(s.data,"Max RDP DCQ");let n=this._getClauseValue(s.data,"Min RDP DCQ");let r={DNQ:i,"Max DCQ":l,"Min DCQ":n};if(this._validationTimeout){clearTimeout(this._validationTimeout)}if(t===""){this._lastValidatedValue=null;return}if(!this._lastValidatedValue||this._lastValidatedValue!==t){this._lastValidatedValue=t;this._validationTimeout=setTimeout(async()=>{if(t.length>=2){try{await m.validateDNQ(o,r,h)}catch(e){console.error("Validation failed:",e)}finally{this._validationTimeout=null}}},1e3)}},onSelectMaterial:async function(e){var t=e.getSource();var i=t.getBindingContext("materialModel");if(i){var o=i.getObject();var a=o.Material;var s=o.RedelivryPoint}const l=`/getRenominationContractData?DocNo=${v}&Material=${a}&Redelivery_Point=${s}&Gasday=${D}`;console.log("sPath",l);let n=this.getOwnerComponent().getModel();const r=n.bindContext(l,null,{});try{const e=await r.requestObject();console.log("Fetched Data:",e.value);const t=new sap.ui.model.json.JSONModel(e.value[0]);this.getView().setModel(t,"contDataModel");var d=this.getView().getModel("localModel");var c=e.value[0].Rpdnq||"0.000";var u="MBT";d.setProperty("/CummDNQ",c+" "+u);const i=this.getView().byId("IdRePubNomGasDayPicker");if(D){const e=new Date(D);i.setDateValue(e)}else{i.setVisible(false)}const o=e.value[0].Redelivery_Point&&e.value[0].Redelivery_Point.trim()!=="";if(o){this.getView().byId("IdRePubNomContractRPDCQ").setVisible(true);var y=this.getView().getModel("RedlvModelData");var m=y.getProperty("/RedeliveryPoints")||[];m.forEach(t=>{t.RedeliveryPt=e.value[0].Redelivery_Point;t.DNQ=e.value[0].Rpdnq;t.UOM="MBT";t.FromT=e.value[0].Redelivery_ValidFrom;t.ToT=e.value[0].Redelivery_ValidTo;t.Event=e.value[0].Event});y.setProperty("/RedeliveryPoints",m)}const a=!!(e.value[0].Delivery_Point&&e.value[0].Delivery_Point.trim());if(a){var g=this.getView().getModel("DelvModelData");var P=g.getProperty("/DeliveryPoints")||[];this.getView().byId("IdRePubNomStaticListS").setVisible(true);this.getView().byId("IdRePubNomContratRPDCQ").setVisible(true);this.getView().byId("IdRePubNomContractDPDCQ").setVisible(true);this.getView().byId("IdRePubNomContractRPDCQ").setVisible(false);this.getView().byId("IdRePubNomStaticListfinal").setVisible(false);this.getView().byId("IdRePubNomDelPointTable").setVisible(true);P.forEach(t=>{t.DeliveryPt=e.value[0].Delivery_Point;t.UOM="MBT";t.DNQ=e.value[0].Pdnq;t.FromT=e.value[0].Delivery_ValidFrom;t.ToT=e.value[0].Delivery_ValidTo;t.Event=e.value[0].Event});g.setProperty("/DeliveryPoints",P)}}catch(e){console.log("error",e)}},onCloseSimulateDialog:function(){this._simulateDialog.close()},Onsimulate:function(){if(!this._simulateDialog){this._simulateDialog=sap.ui.xmlfragment("com.ingenx.nomination.salesnomination.fragment.simulatePopup",this);this.getView().addDependent(this._simulateDialog)}this._simulateDialog.open()},updateNomination:async function(){try{let e=this.getView().byId("IdRePubNomGasDayPicker").getDateValue();if(!e){sap.m.MessageBox.error("Please select a Gas Day!");oBusyDialog.close();return}const t=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});e=t.format(e);const i=this.getView().getModel("RedlvModelData").getData();const o=this.getView().getModel("DelvModelData").getData();const a=this.getView().getModel("contDataModel").getData();let s={Gasday:e,Vbeln:a.DocNo?a.DocNo:"",ItemNo:"10",Material:a.Material?a.Material:"",Auart:"ZGSA",Ddcq:a.Delivery_Dcq?a.Delivery_Dcq:"0.000",Rdcq:a.Redelivery_Dcq?a.Redelivery_Dcq:"0.000",Uom1:i.RedeliveryPoints&&i.RedeliveryPoints[0]&&i.RedeliveryPoints[0].UOM?i.RedeliveryPoints[0].UOM:o.DeliveryPoints&&o.DeliveryPoints[0]&&o.DeliveryPoints[0].UOM?o.DeliveryPoints[0].UOM:"",Pdnq:o.DeliveryPoints&&o.DeliveryPoints[0]&&o.DeliveryPoints[0].DNQ?o.DeliveryPoints[0].DNQ:"0.000",Rpdnq:i.RedeliveryPoints&&i.RedeliveryPoints[0]&&i.RedeliveryPoints[0].DNQ?i.RedeliveryPoints[0].DNQ:"0.000",Event:i.RedeliveryPoints&&i.RedeliveryPoints[0]&&i.RedeliveryPoints[0].Event?i.RedeliveryPoints[0].Event:o.DeliveryPoints&&o.DeliveryPoints[0]&&o.DeliveryPoints[0].Event?o.DeliveryPoints[0].Event:"",ValidFrom:i.RedeliveryPoints&&i.RedeliveryPoints[0]&&i.RedeliveryPoints[0].FromT?i.RedeliveryPoints[0].FromT:o.DeliveryPoints&&o.DeliveryPoints[0]&&o.DeliveryPoints[0].FromT?o.DeliveryPoints[0].FromT:"",ValidTo:i.RedeliveryPoints&&i.RedeliveryPoints[0]&&i.RedeliveryPoints[0].ToT?i.RedeliveryPoints[0].ToT:o.DeliveryPoints&&o.DeliveryPoints[0]&&o.DeliveryPoints[0].ToT?o.DeliveryPoints[0].ToT:"",DeliveryPoint:a.Delivery_Point?a.Delivery_Point:"",RedelivryPoint:a.Redelivery_Point?a.Redelivery_Point:""};const l=`/nomi_SaveSet(Gasday='${e}',Vbeln='${a.DocNo}')`;console.log("sPath",l);let n=this.getOwnerComponent().getModel();const r=n.bindContext(l,null,{});const d=await r.requestObject();console.log("Fetched Data:",d);const c=r.getBoundContext();if(c){c.setProperty("Rpdnq",s.Rpdnq);c.setProperty("Pdnq",s.Pdnq);c.setProperty("ValidFrom",s.ValidFrom);c.setProperty("ValidTo",s.ValidTo);c.setProperty("Event",s.Event);await n.submitBatch(n.getUpdateGroupId());sap.m.MessageToast.show("Rpdnq updated successfully!")}else{sap.m.MessageBox.error("Failed to bind context for update.")}}catch(e){console.error("Error updating nomination:",e);sap.m.MessageBox.error("Failed to update nomination. Please try again.")}}})});
//# sourceMappingURL=publishRenomination.controller.js.map