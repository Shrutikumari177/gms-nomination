sap.ui.define(["sap/ui/Device","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","com/ingenx/nomination/salesnomination/utils/HelperFunction","sap/m/Popover","sap/m/Button","sap/m/library","sap/viz/ui5/controls/common/feeds/FeedItem","sap/viz/ui5/data/FlattenedDataset","sap/m/MessageBox","sap/m/MessageToast","external/ChartJSAdapterDateFns","external/ChartJS"],function(e,t,a,o,r,l,n,i,s,c,u,d,g,m){"use strict";let p;let y=Number.MAX_SAFE_INTEGER;let h=0;let V=0;let v;let f;let M;return a.extend("com.ingenx.nomination.salesnomination.controller.systemNom",{onInit:function(){},soldToPartyValueHelp:async function(e){try{let t="_customerSelectDialog";let a="com.ingenx.nomination.salesnomination.fragment.soldToParty";this._currentValueHelpSource=e.getSource();await r._openValueHelpDialog(this,t,a)}catch(e){console.error("Error opening value help dialog:",e);sap.m.MessageBox.error("Could not open value help. Please contact support.")}},onValueHelpConfirmSTP:async function(e){try{let t=this._currentValueHelpSource;f=r._valueHelpSelectedValue(e,this,t.getId());if(!f)return;let a=this.getView();let o=await r._getSingleEntityDataWithParam(this,"getNominationsByCustomer","SoldToParty",f);if(o&&o.length){let e=new sap.ui.model.json.JSONModel({data:o});a.setModel(e,"newModelForContracts");a.getModel("newModelForContracts").refresh()}}catch(e){console.error("Unexpected error:",e.message||e);sap.m.MessageBox.error("An unexpected error occurred. Please try again.")}finally{this._customerSelectDialog.getBinding("items").filter([])}},onValueHelpSearchSTP:function(e){r._valueHelpLiveSearch(e,"Customer","soldToParty",this)},contractValueHelp:async function(e){try{let t="_contractSelectDialog";let a="com.ingenx.nomination.salesnomination.fragment.selectContract";this._currentValueHelpSource=e.getSource();await r._openValueHelpDialog(this,t,a)}catch(e){console.error("Error opening value help dialog:",e);sap.m.MessageBox.error("Could not open value help. Please contact support.")}},onValueHelpConfirmContract:async function(e){try{let t=this._currentValueHelpSource;let a=r._valueHelpSelectedValue(e,this,t.getId());if(!a){console.error("No contract selected.");return}console.log("Selected Contract:",a);const o=`/getContractDetailsAndPastNom?DocNo='${a}'`;console.log("Fetching from path:",o);let l=this.getOwnerComponent().getModel();const n=l.bindContext(o,null,{});try{const e=await n.requestObject();console.log("Fetched Data:",e);if(!e||!e.value||e.value.length===0){console.error("No data received or empty data array!");sap.m.MessageToast.show("No materials found.");return}let t=this.getView();let a=t.getModel("materialModel");if(!a){a=new sap.ui.model.json.JSONModel;t.setModel(a,"materialModel")}a.setProperty("/data",e.value);a.updateBindings(true);a.refresh(true);console.log("Updated Model Data:",a.getData())}catch(e){console.error("Error fetching contract details:",e);sap.m.MessageBox.error("Failed to fetch contract details. Please try again later.")}}catch(e){console.error("Unexpected error:",e);sap.m.MessageBox.error("An unexpected error occurred.")}},onValueHelpSearchContract:function(e){r._valueHelpLiveSearch(e,"DocNo","DocNo",this)},materialValueHelp:async function(e){try{let t="_materialSelectDialog";let a="com.ingenx.nomination.salesnomination.fragment.selectMaterial";this._currentValueHelpSource=e.getSource();await r._openValueHelpDialog(this,t,a)}catch(e){console.error("Error opening value help dialog:",e);sap.m.MessageBox.error("Could not open value help. Please contact support.")}},onValueHelpConfirmMaterial:async function(e){try{let t=this._currentValueHelpSource;let a=r._valueHelpSelectedValue(e,this,t.getId());if(!a)return;let o=e.getParameter("selectedItem");if(!o)return;let l=o.getBindingContext("materialModel");if(!l)return;let n=l.getObject();let i=n.Material;let s=n.Redelivery_Point;let c=n.DocNo;if(!c||!i||!s){sap.m.MessageBox.error("Missing required data: DocNo, Material, or Redelivery_Point.");return}const u=`/getContractDetail?DocNo='${c}'&Material='${i}'&Redelivery_Point='${s}'`;console.log("API Call:",u);let d=this.getOwnerComponent().getModel();let g=d.bindContext(u,null,{});const m=await g.requestObject();console.log("Fetched Contract Data:",m.value);if(!m.value||m.value.length===0){sap.m.MessageBox.warning("No contract details found for the selected material.");return}let p=m.value[0];this.getView().byId("contractRDPDCQ").setValue(p.Redelivery_Dcq||"");this.getView().byId("contractUOM").setValue(p.UOM||"");this.getView().byId("ContractRedeliveryPoint").setValue(p.Redelivery_Point||"")}catch(e){console.error("Error fetching contract details:",e);sap.m.MessageBox.error("Failed to fetch contract details. Please try again.")}},onSubmitSysNomDData1:function(){var e=this.getView();var t=this.getOwnerComponent().getModel();var a=t.bindList("/systemNomination");var o={Vbeln:e.byId("registrationMapping_emailID").getValue(),soldToParty:e.byId("registrationMapping_retailerName").getValue(),Material:e.byId("registrationMapping_contactNo").getValue(),Rdcq:parseFloat(e.byId("contractRDPDCQ").getValue())||0,Uom:e.byId("contractUOM").getValue(),RedelivryPoint:e.byId("ContractRedeliveryPoint").getValue(),Rpdnq:parseFloat(e.byId("registrationMapping_district").getValue())||0,ValidTo:e.byId("IdsysPubNomDelvtoTimePicker").getValue(),ValidFrom:e.byId("IdsysPubNomDelvFromTimePicker").getValue()};if(!o.Vbeln){u.error("Contract No. is required!");return}var r=a.create(o);r.created().then(()=>{u.success("System Nomination created successfully!");t.refresh()}).catch(e=>{u.error("Failed to create System Nomination: "+e.message)})},onSubmitSysNomDData:function(){var e=this.getView();var t=this.getOwnerComponent().getModel();var a=t.bindList("/systemNomination");var o=e.byId("IdsysPubNomDelvFromTimePicker").getDateValue();var r=e.byId("IdsysPubNomDelvtoTimePicker").getDateValue();var l=o?o.toISOString().split("T")[0]:null;var n=r?r.toISOString().split("T")[0]:null;var i={Vbeln:e.byId("registrationMapping_emailID").getValue(),soldToParty:e.byId("registrationMapping_retailerName").getValue(),Material:e.byId("registrationMapping_contactNo").getValue(),Rdcq:parseFloat(e.byId("contractRDPDCQ").getValue())||0,Uom:e.byId("contractUOM").getValue(),RedelivryPoint:e.byId("ContractRedeliveryPoint").getValue(),Rpdnq:parseFloat(e.byId("registrationMapping_district").getValue())||0,ValidTo:n,ValidFrom:l};if(!i.Vbeln){u.error("Contract No. is required!");return}if(!i.ValidFrom||!i.ValidTo){u.error("Valid From and Valid To dates are required!");return}if(new Date(i.ValidFrom)>new Date(i.ValidTo)){u.error("Valid From date cannot be later than Valid To date!");return}var s=a.create(i);s.created().then(()=>{u.success("System Nomination created successfully!");t.refresh()}).catch(e=>{u.error("Failed to create System Nomination: "+e.message)})}})});
//# sourceMappingURL=systemNom.controller.js.map