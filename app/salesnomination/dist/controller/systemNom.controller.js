sap.ui.define(["sap/ui/Device","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","com/ingenx/nomination/salesnomination/utils/HelperFunction","sap/m/Popover","sap/m/Button","sap/m/library","sap/viz/ui5/controls/common/feeds/FeedItem","sap/viz/ui5/data/FlattenedDataset","sap/m/MessageBox","sap/m/MessageToast","external/ChartJSAdapterDateFns","external/ChartJS"],function(e,t,o,a,l,i,n,r,s,c,u,d,g,D){"use strict";let m;let p;return o.extend("com.ingenx.nomination.salesnomination.controller.systemNom",{onInit:function(){this._oBusyDialog=new sap.m.BusyDialog;const e={DeliveryPoints:[{DeliveryPt:"",DNQ:"",UOM:"",MaxDP_DCQ:"",MinDP_DCQ:""}]};const t={RedeliveryPoints:[{RedeliveryPt:"",DNQ:"",UOM:"",MaxRDP_DCQ:"",MinRDP_DCQ:""}]};const o=new sap.ui.model.json.JSONModel(e);const a=new sap.ui.model.json.JSONModel(t);this.getView().setModel(o,"DelvModelData");this.getView().setModel(a,"RedlvModelData")},documenttypeValueHelp:async function(e){try{this._resetContractDataViews();let t="_documentSelectDialog";let o="com.ingenx.nomination.salesnomination.fragment.selectDocumentType";this._currentValueHelpSource=e.getSource();await l._openValueHelpDialog(this,t,o)}catch(e){console.error("Error opening value help dialog:",e);sap.m.MessageBox.error("Could not open value help. Please contact support.")}},_resetContractDataViews:function(){const e=this.getView();e.byId("IdSysNomDelPointTable").setVisible(false);e.byId("IdSysNomTableHeaderBarForDelv").setVisible(false);const t=["sysNom_ValidTo","sysNom_ValidFrom","sysNom_Contract","sysNom_Material","sysNom_SoldToParty","sysNom_DocumentType"];t.forEach(function(t){let o=e.byId(t);if(o){o.setValue("")}});const o=e.getModel("RedlvModelData");if(o){o.setProperty("/RedeliveryPoints",[{RedeliveryPt:"",DNQ:"",UOM:"",MaxRDP_DCQ:"",MinRDP_DCQ:""}])}const a=e.getModel("DelvModelData");if(a){a.setProperty("/DeliveryPoints",[{DeliveryPt:"",DNQ:"",UOM:"",MaxDP_DCQ:"",MinDP_DCQ:""}])}const l=e.getModel("contDataModel");if(l){l.setData({})}},onValueHelpConfirmDocument:async function(e){try{let t=this._currentValueHelpSource;p=l._valueHelpSelectedValue(e,this,t.getId());if(!p){return}}catch(e){console.error("Unexpected error:",e.message||e)}finally{this._documentSelectDialog.getBinding("items").filter([])}},soldToPartyValueHelp:async function(e){try{let t="_customerSelectDialog";let o="com.ingenx.nomination.salesnomination.fragment.soldToParty";this._currentValueHelpSource=e.getSource();await l._openValueHelpDialog(this,t,o)}catch(e){console.error("Error opening value help dialog:",e);sap.m.MessageBox.error("Could not open value help. Please contact support.")}},onValueHelpConfirmSTP:async function(e){try{let t=this._currentValueHelpSource;m=l._valueHelpSelectedValue(e,this,t.getId());if(!m)return;let o=this.getView();const a=`/getContractsByCustomerNDocType?SoldToParty='${m}'&DocTyp='${p}'`;let i=this.getOwnerComponent().getModel();const n=i.bindList(a);const r=await n.requestContexts(0,Infinity);const s=r.map(e=>e.getObject());console.log("aContracts",s);if(s&&s.length){let e=new sap.ui.model.json.JSONModel({data:s});o.setModel(e,"newModelForContracts");o.getModel("newModelForContracts").refresh()}}catch(e){console.error("Unexpected error:",e.message||e);sap.m.MessageBox.error("An unexpected error occurred. Please try again.")}finally{this._customerSelectDialog.getBinding("items").filter([])}},onValueHelpSearchSTP:function(e){l._valueHelpLiveSearch(e,"Customer","soldToParty",this)},contractValueHelp:async function(e){try{let t="_contractSelectDialog";let o="com.ingenx.nomination.salesnomination.fragment.selectContract";this._currentValueHelpSource=e.getSource();await l._openValueHelpDialog(this,t,o)}catch(e){console.error("Error opening value help dialog:",e);sap.m.MessageBox.error("Could not open value help. Please contact support.")}},onValueHelpConfirmContract:async function(e){try{let t=this._currentValueHelpSource;let o=l._valueHelpSelectedValue(e,this,t.getId());if(!o){console.error("No contract selected.");return}console.log("Selected Contract:",o);const a=`/getContractDetailsAndPastNom?DocNo='${o}'`;console.log("Fetching from path:",a);let i=this.getOwnerComponent().getModel();const n=i.bindContext(a,null,{});try{const e=await n.requestObject();console.log("Fetched Data:",e);if(!e||!e.value||e.value.length===0){console.error("No data received or empty data array!");sap.m.MessageToast.show("No materials found.");return}let t=this.getView();let o=t.getModel("materialModel");if(!o){o=new sap.ui.model.json.JSONModel;t.setModel(o,"materialModel")}o.setProperty("/data",e.value);o.updateBindings(true);o.refresh(true);console.log("Updated Model Data:",o.getData())}catch(e){console.error("Error fetching contract details:",e);sap.m.MessageBox.error("Failed to fetch contract details. Please try again later.")}}catch(e){console.error("Unexpected error:",e);sap.m.MessageBox.error("An unexpected error occurred.")}},onValueHelpSearchContract:function(e){l._valueHelpLiveSearch(e,"DocNo","DocNo",this)},materialValueHelp:async function(e){try{let t="_materialSelectDialog";let o="com.ingenx.nomination.salesnomination.fragment.selectMaterial";this._currentValueHelpSource=e.getSource();await l._openValueHelpDialog(this,t,o)}catch(e){console.error("Error opening value help dialog:",e);sap.m.MessageBox.error("Could not open value help. Please contact support.")}},onValueHelpConfirmMaterial:async function(e){try{let t=this._currentValueHelpSource;let o=l._valueHelpSelectedValue(e,this,t.getId());if(!o)return;let a=e.getParameter("selectedItem");if(!a)return;let i=a.getBindingContext("materialModel");if(!i)return;let n=i.getObject();let r=n.Material;let s=n.Redelivery_Point;let c=n.DocNo;if(!c||!r||!s){sap.m.MessageBox.error("Missing required data: DocNo, Material, or Redelivery_Point.");return}const u=`/getContractDetail?DocNo='${c}'&Material='${r}'&Redelivery_Point='${s}'`;console.log("API Call:",u);let d=this.getOwnerComponent().getModel();let g=d.bindContext(u,null,{});const D=await g.requestObject();console.log("Fetched Contract Data:",D.value);if(!D.value||D.value.length===0){sap.m.MessageBox.warning("No contract details found for the selected material.");return}let m=D.value[0];let p=m.data||[];let y=new sap.ui.model.json.JSONModel(D.value[0]);this.getView().setModel(y,"contDataModel");this._updateRedeliveryData(D.value[0]);this._updateDeliveryData(D.value[0])}catch(e){console.error("Error fetching contract details:",e);sap.m.MessageBox.error("Failed to fetch contract details. Please try again.")}},_updateRedeliveryData:function(e){const t=e.Redelivery_Point&&e.Redelivery_Point.trim()!=="";if(t){let t=this.getView().getModel("RedlvModelData");let o=t.getProperty("/RedeliveryPoints")||[];const a=e.data||[];const l=this._getClauseValue(a,"Max RDP DCQ");const i=this._getClauseValue(a,"Min RDP DCQ");o.forEach(t=>{t.RedeliveryPt=e.Redelivery_Point;t.UOM="MBT";t.MaxRDP_DCQ=l||"";t.MinRDP_DCQ=i||""});t.setProperty("/RedeliveryPoints",o)}},_updateDeliveryData:function(e){const t=!!(e.Delivery_Point&&e.Delivery_Point.trim());if(t){let t=this.getView();t.byId("IdSysNomDelPointTable").setVisible(true);t.byId("IdSysNomTableHeaderBarForDelv").setVisible(true);let o=t.getModel("DelvModelData");let a=o.getProperty("/DeliveryPoints")||[];const l=e.data||[];const i=this._getClauseValue(l,"Max DP DCQ");const n=this._getClauseValue(l,"Min DP DCQ");a.forEach(t=>{t.DeliveryPt=e.Delivery_Point;t.UOM="MBT";t.MaxDP_DCQ=i||"";t.MinDP_DCQ=n||""});o.setProperty("/DeliveryPoints",a)}},_getClauseValue:function(e,t){let o=e.find(e=>e.Clause_Code===t);return o?parseFloat(o.Calculated_Value)||0:0},onCancelSysNomDData:function(){this._resetContractDataViews()},onSubmitSysNomDData:async function(){const e=this.getView();const t=new sap.m.BusyDialog;t.open();try{const o=e.getModel("RedlvModelData").getData();const a=e.getModel("DelvModelData").getData();const l=e.getModel("contDataModel").getData();const i=e.byId("sysNom_ValidFrom").getDateValue();const n=e.byId("sysNom_ValidTo").getDateValue();function r(e){if(!e)return null;const t=e.getTimezoneOffset()*6e4;const o=new Date(e.getTime()-t).toISOString().split("T")[0];return o}const s=r(i);const c=r(n);let u={Vbeln:l.DocNo,Redelivrypoint:l.Redelivery_Point,ValidFrom:s,ValidTo:c,SoldToParty:l.SoldToParty,Material:l.Material,DpDnq:a.DeliveryPoints[0].DNQ||"0.000",Uom:l.UOM,RpDnq:o.RedeliveryPoints[0].DNQ||"0.000",DeliveryPoint:l.Delivery_Point,Event:"No-event"};const d=this.getOwnerComponent().getModel();const g=d.bindList("/Nom_DetailSet");g.attachEventOnce("createCompleted",function(e){t.close();const o=e.getParameter("success");if(o){sap.m.MessageBox.success("Nomination Successfully Submitted");this._resetContractDataViews()}else{const t=e.getParameter("context");const o=t.oModel.mMessages?.[""]||[];const a=o[0]?.message||"Nomination submission failed.";sap.m.MessageBox.error(a)}},this);g.create(u,false)}catch(D){console.error("Unexpected error:",D);t.close();sap.m.MessageBox.error("Unexpected error occurred while submitting nomination.")}},OnReDeliveryDNQValidation:function(e){let t=e.getParameter("value").trim();let o=parseFloat(t)||0;let a=this.getView();let i=a.getModel("contDataModel").getData();let n=i.Profile;let r=this._getClauseValue(i.data,"Max RDP DCQ");let s=this._getClauseValue(i.data,"Min RDP DCQ");let c={DNQ:o,"Max RDP DCQ":r,"Min RDP DCQ":s};let d=false;console.log("isrelax",d);if(this._validationTimeout){clearTimeout(this._validationTimeout)}if(!this._lastValidatedValue||this._lastValidatedValue!==t){this._lastValidatedValue=t;this._validationTimeout=setTimeout(async()=>{if(t.length>=1){try{let t=await l.validateDNQ(a,c,m,n,d);if(!t.isValid){u.error(t.message,{onClose:()=>{e.getSource().setValue("")}})}}catch(t){console.error("Validation failed:",t);u.error("Validation error occurred.",{onClose:()=>{e.getSource().setValue("")}})}finally{this._validationTimeout=null}}},1e3)}},debounce:function(e,t){let o;return function(...a){clearTimeout(o);o=setTimeout(()=>e.apply(this,a),t)}},OnDeliveryDNQValidation:function(e){let t=e.getParameter("value").trim();let o=parseFloat(t)||0;let a=this.getView();if(!t){this._lastValidatedValue=null;return}let i=a.getModel("contDataModel").getData();let n=i.Profile;let r=this._getClauseValue(i.data,"Max DP DCQ");let s=this._getClauseValue(i.data,"Min DP DCQ");let c={DNQ:o,"Max DP DCQ":r,"Min DP DCQ":s};let d=false;console.log("isrelax",d);if(this._validationTimeout){clearTimeout(this._validationTimeout)}if(t===""){this._lastValidatedValue=null;return}if(!this._lastValidatedValue||this._lastValidatedValue!==t){this._lastValidatedValue=t;this._validationTimeout=setTimeout(async()=>{if(t.length>=1){try{let t=await l.validateDNQ(a,c,m,n,d);if(!t.isValid){u.error(t.message,{onClose:()=>{e.getSource().setValue("")}})}}catch(t){u.error("Validation error occurred.",{onClose:()=>{e.getSource().setValue("")}})}finally{this._validationTimeout=null}}},1e3)}}})});
//# sourceMappingURL=systemNom.controller.js.map